/*! TT 08-04-2014 */
var TT={name:"Timeline Tools",author:{name:"Florian KrÃ¤utli",email:"florian@kraeutli.com",twitter:"@fkraeutli",url:"http://www.kraeutli.com"},version:"0.0.1"};TT.bars=function(){function a(){var a=(j.elements.events.selectAll("g.bars_event"),j.svg.select(".bars_axis"));j.scales.axis.domain([j.scales.pxToDate(l.domain()[0]),j.scales.pxToDate(l.domain()[1])]),b(),a.call(j.axis)}function b(){function a(a){a.append("rect").attr("class","eventRect").attr("x",0).attr("y",0).attr("height",k.event.rect.height).attr("width",k.event.rect.width).style("fill",k.event.rect.fill),a.append("text").attr("class","title").text(function(a){return a.title}).attr("x",k.event.text.x).attr("y",k.event.text.y).attr("text-anchor",k.event.text.anchor).attr("display",k.event.text.display)}function b(a){return a[h].renderLevel>=j.thresholds.display&&l(a[h].x)+a[h].width*e.scale()>=0&&l(a[h].x)<=j.view.width&&a[h].y+m(0)>-j.styles.events.height&&a[h].y+m(0)<j.view.height}function c(){function a(a){return a.weight?Math.pow(j.scales.minMax.weight(a.weight),.01/j.scales.minMax.zoom(e.scale()))+j.scales.minMax.zoom(e.scale()):0}j.data.forEach(function(b){b[h].renderLevel=a(b)}),(j.data.length<=j.thresholds.showAll||d3.min(j.data,function(a){return a[h].renderLevel})==d3.max(j.data,function(a){return a[h].renderLevel}))&&j.data.forEach(function(a){a[h].renderLevel=1});var b=0;j.data.forEach(function(a){a[h].renderLevel>=j.thresholds.display&&(a[h].x=j.scales.dateToPx(a.from.valueOf()),a[h].width=j.scales.dateToPx(a.to.valueOf())-j.scales.dateToPx(a.from.valueOf()),a[h].height=a[h].renderLevel<j.thresholds.collapse?j.styles.events.collapsedHeight:j.styles.events.height,a[h].margin=a[h].renderLevel<j.thresholds.collapse?j.styles.events.collapsedMargin:j.styles.events.margin,a[h].y=0===b?j.view.padding:j.view.ys[b-1]+a[h].margin,j.view.ys[b]=a[h].y+a[h].height,b++)})}function i(a){a.select("rect.eventRect").attr("width",k.event.rect.width).attr("height",k.event.rect.height).style("fill",k.event.rect.fill),a.select("text.title").attr("x",k.event.text.x).attr("y",k.event.text.y).attr("text-anchor",k.event.text.anchor).attr("display",k.event.text.display).style("font-size",k.event.text.fontSize)}if(!f)return!1;c(),j.displayData=j.data.filter(b);var n=j.elements.events.selectAll("g.bars_event").data(j.displayData,function(a){return a.id});n.attr("transform",k.event.transform),i(n);var o=n.enter().append("g").attr("id",function(a){return"tl"+g+"_event_"+a.id}).attr("class","bars_event").attr("transform",k.event.transform).on("click",function(a){console.log(a)}).on("dblclick",function(a){a.url&&window.open(a.url)});a(o),n.exit().remove(),d()}function c(){j.scales.minMax.weight.domain([d3.min(j.data,function(a){return a.weight?a.weight:0}),Math.min(300,d3.max(j.data,function(a){return a.weight?a.weight:0}))])}function d(){i.hasOwnProperty("publish")&&i.publish(j.displayData)}TT.bars.id||(TT.bars.id=0);var e,f=!1,g=TT.bars.id++,h="tl_"+g,i={},j={axis:{},data:[],displayData:[],elements:{},format:{year:d3.time.format("%Y"),date:d3.time.format("%d %b %Y")},scales:{minMax:{weight:d3.scale.linear().domain([0,1]).range([0,1]),zoom:d3.scale.linear().domain([.01,120]).range([0,1])}},styles:{events:{height:12,collapsedHeight:2,fontSize:12,margin:1,collapsedMargin:1,padding:2}},thresholds:{collapse:.5,display:.1,showAll:10},view:{from:new Date(1900,0,1),to:new Date(2e3,0,1),width:800,height:600,padding:40,ys:[0]}};test_bars_p=j;var k={axis:{tickFormat:function(a){return Math.round((j.axis.scale().domain()[1].getFullYear()-j.axis.scale().domain()[0].getFullYear())/j.axis.ticks())>=1?j.format.year(a):j.format.date(a)}},event:{rect:{fill:function(a){return a.color||null},height:function(a){return Math.min(a[h].height*e.scale(),a[h].height)+"px"},width:function(a){return a[h].width*e.scale()+"px"}},text:{anchor:function(a){return e.scale()>=j.thresholds.collapse&&a[h].width*e.scale()>a.title.length*j.styles.events.fontSize?"start":"end"},display:function(a){return a[h].renderLevel>j.thresholds.collapse?"block":"none"},fontSize:j.styles.events.fontSize+"px",x:function(a){return a[h].width*e.scale()>a.title.length*j.styles.events.fontSize?l(a[h].x)<0&&l(a[h].x)+a[h].width*e.scale()>0?j.styles.events.padding+-1*l(a[h].x):j.styles.events.padding:-j.styles.events.padding},y:.75*j.styles.events.height},transform:function(a){return"translate("+l(a[h].x)+","+(a[h].y+m(0))+")"}}},l=d3.scale.linear().domain([0,j.view.width]).range([0,j.view.width]),m=d3.scale.linear().domain([0,j.view.height]).range([0,j.view.height]);return i.apply=function(){function c(){function b(){j.scales.axis=d3.time.scale().domain([j.scales.pxToDate(l.domain()[0]),j.scales.pxToDate(l.domain()[1])]).range([0,j.view.width]),j.axis=d3.svg.axis().scale(j.scales.axis).tickSize(j.view.height-j.view.padding).tickFormat(k.axis.tickFormat).orient("top"),j.elements.axis=j.svg.append("g").attr("class","bars_axis").attr("id","tl"+g+"_axis").call(j.axis).attr("transform","translate(0,"+(j.view.height-j.view.padding/2)+")")}function c(){j.elements.events=j.svg.insert("g").attr("class","bars_events").attr("id","tl"+g+"_events")}function d(){j.scales.dateToPx=d3.scale.linear().domain([j.view.from.valueOf(),j.view.to.valueOf()]).range([j.view.padding,j.view.width-j.view.padding]),j.scales.pxToDate=d3.scale.linear().domain([j.view.padding,j.view.width-j.view.padding]).range([j.view.from.valueOf(),j.view.to.valueOf()])}function f(){e=d3.behavior.zoom().x(l).y(m).scaleExtent(j.scales.minMax.zoom.domain()),j.svg.select(".bars_events").insert("rect",":first-child").attr("width",j.view.width).attr("height",j.view.height).attr("class","overlay"),j.svg.select(".bars_events").call(e.on("zoom",a)).on("dblclick.zoom",null)}d(),c(),b(),f()}if(j.svg=arguments[0],j.view.width=j.svg.attr("width"),j.view.height=j.svg.attr("height"),j.data){var d=d3.min(j.data,function(a){return a.from}),h=d3.max(j.data,function(a){return a.to});j.view.from=new Date(d.valueOf()-.2*(h.valueOf()-d.valueOf())),j.view.to=new Date(h.valueOf()+.2*(h.valueOf()-d.valueOf()))}c(),f=!0,b()},i.data=function(a){return arguments.length?(j.data=a,j.data.forEach(function(a){a.hasOwnProperty(h)||(a[h]={})}),c(),b(),i):j.data},i.displayData=function(){return j.displayData},i.update=function(){b()},i.x=function(a){return arguments.length?(l=a,i):l},i.y=function(a){return arguments.length?(m=a,i):m},i.zoom=function(a){return arguments.length?(e=a,i):e},i.styles={},i.styles.events=function(a,c){if(arguments.length<2){if("string"==typeof a)return j.styles.events[a];if("object"==typeof a)for(var d in a)j.styles.events[d]=a[d]}else j.styles.events[a]=c;return b(),i},i.threshold=function(a,c){if(arguments.length<2){if("string"==typeof a)return j.thresholds[a];if("object"==typeof a)for(var d in a)j.thresholds[d]=a[d]}else j.thresholds[a]=c;return b(),i},i},TT.crossfilter=function(){function a(a){var c;switch(a.type){case f:c=(new d).dimension(a.dimension).group(a.group).title(a.title),c.x(a.isDate?d3.time.scale().domain([a.min,a.max]).rangeRound([0,q.view.width]):d3.scale.linear().domain([a.min,a.max]).rangeRound([0,q.view.width])),c.on("brush",b).on("brushend",b);break;case g:c=(new e).dimension(a.dimension).group(a.group).title(a.title);break;default:console.error("Invalid filter "+a.type)}return l.push(c),k.call(c),c}function b(){for(var a=0;a<l.length;a++)l[a].drawChart();c()}function c(){p.hasOwnProperty("publish")&&l.length&&(publishFrom=o||l[0],p.publish(publishFrom.dimension().top(1/0)))}function d(){function a(){s.on("brushstart.chart",function(){var a=d3.select(this.parentNode.parentNode.parentNode);a.select(".title a.reset").style("display","block")}),s.on("brush.chart",function(){var a=d3.select(this.parentNode),b=s.extent();i&&a.select(".brush").call(s.extent(b=b.map(i))),a.select("#clip-"+n+" rect").attr("x",e(b[0])).attr("width",e(b[1])-e(b[0])),g.filterRange(b)}),s.on("brushend.chart",function(){if(s.empty()){var a=d3.select(this.parentNode.parentNode.parentNode);a.select(".title a.reset").style("display","none"),a.select("#clip-"+n+" rect").attr("x",null).attr("width","100%"),g.filterAll()}})}var d,e,f,g,h,i,j,k={},m=d3.scale.linear().range([q.view.height,0]),n=l.length,p=d3.svg.axis().orient("bottom"),r=20,s=d3.svg.brush();return k.apply=function(){try{d=arguments[0]}catch(b){console.error("No DOM element specified")}d=d.append("div").attr("id","barChart_"+n).attr("class","chart barchart"),a(),k.drawChart()},k.drawChart=function(a){function b(a){for(var b,c=[],d=-1,f=a.length;++d<f;)b=a[d],c.push("M",e(b.key),",",i,"V",m(b.value),"h9V",i);return c.join("")}function c(){var a=d.append("div").attr("class","title").text(j);a.append("a").attr("class","reset").text("Reset").on("click",k.reset),a.append("a").attr("class","sort").text("Sort by").style("display",0===n?"none":"").on("click",function(){k.sortBy(n)}),l=d.append("svg").attr("width",g).attr("height",i+r).append("g"),l.append("clipPath").attr("id","clip-"+n).append("rect").attr("width",g).attr("height",i),l.selectAll(".bar").data(["background","foreground"]).enter().append("path").attr("class",function(a){return a+" bar"}).datum(h.all()),l.selectAll(".foreground.bar").attr("clip-path","url(#clip-"+n+")"),l.append("g").attr("class","axis").attr("transform","translate(0, "+i+")").call(p);var b=l.append("g").attr("class","brush").call(s);b.selectAll("rect").attr("height",i)}var g=e.range()[1],i=m.range()[0];m.domain([0,h.top(1)[0].value]);var l=d.select("g");if((l.empty()||a)&&c(),f)if(f=!1,l.selectAll(".brush").call(s),d.select(".title a.reset").style("display",s.empty()?"":"block"),s.empty())l.selectAll("#clip-"+n+" rect").attr("x",0).attr("width",g);else{var o=s.extent();l.selectAll("#clip-"+n+" rect").attr("x",e(o[0])).attr("width",e(o[1])-e(o[0]))}l.selectAll(".bar").attr("d",b)},k.reset=function(){l[n].filter(null),b()},k.redrawChart=function(){d.select("svg").remove(),d.select(".title").remove(),k.drawChart(!0)},k.sortBy=function(a){d3.selectAll(".title .sort").style("display","block"),d3.select("#barChart_"+a+" .sort").style("display","none"),o=l[a],c()},k.dimension=function(a){return arguments.length?(g=a,k):g},k.filter=function(a){return a?(s.extent(a),g.filterRange(a)):(s.clear(),g.filterAll()),f=!0,k},k.group=function(a){return arguments.length?(h=a,k):h},k.round=function(a){return arguments.length?(i=a,k):i},k.title=function(a){return arguments.length?(j=a,k):j},k.x=function(a){return arguments.length?(e=a,p.scale(e),s.x(e),k):e},k.y=function(a){return arguments.length?(m=a,k):m},d3.rebind(k,s,"on")}function e(){e.id||(e.id=0);var a,d,f,g,h=[],i={},j=l.length;return i.apply=function(){try{d=arguments[0]}catch(a){return console.error("No DOM element specified"),!1}d=d.append("div").attr("id","wordCloud_"+j).attr("class","chart wordCloud"),i.drawChart()},i.drawChart=function(c){function e(){var a=d.append("div").attr("class","title").text(g);a.append("a").attr("class","reset").text("Reset").on("click",i.reset),a.append("a").attr("class","sort").text("Sort by").style("display",0===j?"none":"").on("click",function(){i.sortBy(j)}),m=d.append("div").attr("width",l).attr("class","wordcloud_container")}function k(a){return-1!==h.indexOf(a)}var l=q.view.width,m=d.select("div.wordcloud_container");(m.empty()||c)&&e();var n=m.selectAll("span").data(f.all().filter(function(a){return a.value>0?a:void 0}),function(a){return a.key}).sort(function(a,b){return b.key<a.key}),o=n.enter(),p=n.exit(),r=d3.scale.linear().domain([0,Math.min(d3.max(f.all(),function(a){return a.value}),10)]).range([0,1]);words_attributes={fontSize:function(a){return 9*Math.min(r(a.value),1)+8+"px"}},n.style("font-size",words_attributes.fontSize),o.append("span").text(function(a){return a.key}).style("font-size",words_attributes.fontSize).attr("class",function(a){return"term term_"+a.key+" "+(-1!==h.indexOf(a.key)?"selected":"")}).on("click",function(c){-1===h.indexOf(c.key)?(h.push(c.key),d3.select(this).classed("selected",1)):(h.splice(h.indexOf(c.key),1),d3.select(this).classed("selected",0)),h.length?(a.filterFunction(k),d3.select(this.parentNode).classed("filtered",1),d.select(".title a.reset").style("display","block")):i.reset(),b()}),p.remove()},i.redrawChart=function(){d.select("div.wordcloud_container").remove(),d.select(".title").remove(),i.drawChart(!0)},i.reset=function(){h=[],a.filterAll(),d.selectAll(".term").style("color",""),d.select(".filtered").classed("filtered",0),d.selectAll(".selected").classed("selected",0),d.select(".title a.reset").style("display",null),b()},i.sortBy=function(a){console.log("Hello"+a),d3.selectAll(".title .sort").style("display","block"),d3.select("#wordCloud_"+a+" .sort").style("display","none"),o=l[a],c()},i.dimension=function(b){return arguments.length?(a=b,i):a},i.group=function(a){return arguments.length?(f=a,i):f},i.title=function(a){return arguments.length?(g=a,i):g},i}var f="continuous",g="tags",h="unique";TT.crossfilter.id||(TT.crossfilter.id=0);var i,j,k,l=[],m=[],n=(TT.crossfilter.id++,!1),o=!1,p={},q={view:{width:400,height:30}};try{i=crossfilter(),test_cf=i}catch(r){return console.error("Crossfilter is not loaded. Get Crossfilter from http://square.github.io/crossfilter/"),!1}return p.apply=function(){k=arguments[0];for(var b=0;b<m.length;b++)a(m[b]);n=!0},p.addFilter=function(b){var c={};c.title=b.title||b.dimension.toString();var d;d="function"==typeof b.dimension?b.dimension:function(a){return a[b.dimension]},c.dimension=i.dimension(d),c.group=c.dimension.group(b.group?b.group:function(a){return a}),c.min=d3.min(j,d),c.max=d3.max(j,d),c.isDate=c.min instanceof Date;for(var e=!0,k=c.group.all(),l=0;l<k.length;l++)if(isNaN(+k[l].key.valueOf())){e=!1;break}return c.type=e?f:c.group.all().length==c.dimension.top(1/0).length?h:g,m.push(c),n&&a(c),p},p.forcePublish=function(){c()},p.charts=function(){return l},p.data=function(a){if(!arguments.length)return j;j=a,i.remove(),i.add(j);for(var b=0;b<l.length;b++)l[b].redrawChart();return c(),p},p.filters=function(){return m},p},String.prototype.ucfirst=function(){return this.charAt(0).toUpperCase()+this.slice(1)},TT.heap=function(){function a(){function a(a){a.append("circle").attr("class","event_circle").attr("cx",h.event.circle.cx).attr("cy",h.event.circle.cy).attr("r",h.event.circle.r).style("fill",h.event.circle.fill)}function b(a){return x(a[f].x)>=0&&x(a[f].x)<=g.view.width&&y(a[f].y)>-g.styles.events.diameter&&y(a[f].y)<g.view.height}function e(){function a(){g.grid.availableWidth=g.scales.dateToPx(g.view.to)-g.scales.dateToPx(g.view.from),g.grid.numCols=Math.floor(g.grid.availableWidth/g.styles.events.diameter),g.grid.range=g.view.to-g.view.from,g.grid.resolution=g.grid.range/g.grid.numCols,g.grid.table=[];for(var a=0;a<g.grid.numCols;a++)g.grid.table[a]=Array();g.grid.maxRow=0,g.data.forEach(function(a){a[f].col=a[f].initCol=Math.min(Math.floor((a.from.valueOf()+(a.to.valueOf()-a.from.valueOf())/2-g.view.from.valueOf())/g.grid.resolution),g.grid.numCols-1),a[f].minCol=Math.max(Math.floor((a.from.valueOf()-g.view.from.valueOf())/g.grid.resolution),0),a[f].maxCol=Math.min(Math.ceil((a.to.valueOf()-g.view.from.valueOf())/g.grid.resolution),g.grid.numCols-1),a[f].candidateCols=d3.range(a[f].initCol,a[f].minCol-1,-1).concat(d3.range(a[f].initCol+1,a[f].maxCol+1));for(var b=g.grid.maxRow,c=0;c<a[f].candidateCols.length;c++)g.grid.table[a[f].candidateCols[c]].length<b&&(a[f].col=a[f].candidateCols[c],b=g.grid.table[a[f].candidateCols[c]].length);a[f].row=b,g.grid.table[a[f].col][a[f].row]=a,b==g.grid.maxRow&&g.grid.maxRow++})}return g.grid.initialised?!1:(a(),g.data.forEach(function(a){a[f].x=g.scales.dateToPx(a[f].col*g.grid.resolution+g.view.from.valueOf());var b=g.grid.table[a[f].col].length*g.styles.events.diameter/2+g.view.height/2;a[f].y=-a[f].row*g.styles.events.diameter+b-b%g.styles.events.diameter}),void(g.grid.initialised=!0))}function i(a){a.select("circle.eventCircle").attr("r",h.event.circle.r).style("fill",h.event.circle.fill)}function j(a){g.zoom.factor>g.thresholds.images?(a.filter(function(a){return!a.hasImage&&a.thumbnailUrl}).append("image").attr("xlink:href",function(a){return a.hasImage=!0,a.thumbnailUrl}),a.selectAll("image").attr("x",-g.zoom.factor/2*g.styles.images.factor).attr("y",-g.zoom.factor/2*g.styles.images.factor).attr("width",g.zoom.factor*g.styles.images.factor+"px").attr("height",g.zoom.factor*g.styles.images.factor+"px")):(a.selectAll("image").remove(),a.each(function(a){a.hasImage=!1}))}if(!c)return!1;e();var k=g.data.filter(b);k.length>g.thresholds.display&&(k=[]);var l=g.elements.events.selectAll("g.heap_event").data(k,function(a){return a.id}),m=l.enter().append("g").attr("id",function(a){return"hs"+d+"_event_"+a.id}).attr("class","heap_event").attr("transform",h.event.transform).on("click",function(a){console.log(a)}).on("dblclick",function(a){a.url&&window.open(a.url)}).each(function(a){a.hasImage=!1});a(m),l.attr("transform",h.event.transform),i(l),l.exit().remove(),j(l),g.elements.outline.attr("d",function(){for(var a,b=[],c=-1,d=g.grid.table.length;++c<d;)a=g.grid.table[c],a.length>0&&(b.push("S",x(a[a.length-1][f].x-g.styles.events.diameter/2),",",y(a[a.length-1][f].y)," ",x(a[a.length-1][f].x),",",y(a[a.length-1][f].y)),b.unshift("S",x(a[0][f].x+g.styles.events.diameter/2),",",y(a[0][f].y)," ",x(a[0][f].x),",",y(a[0][f].y)));return b.unshift("M",b[1],",",b[3]),b.push("Z"),b.join("")}).attr("display",function(){return k.length>0?"none":""})}function b(){if(g.data){var a=d3.min(g.data,function(a){return a.from}),b=d3.max(g.data,function(a){return a.to});g.view.from=a,g.view.to=b}}TT.heap.id||(TT.heap.id=0);var c=!1,d=TT.heap.id++,e={},f="hp_"+d,g={data:[],elements:{},grid:{availableWidth:null,maxRow:0,numCols:null,initialised:!1,range:null,resolution:null,table:[]},styles:{events:{diameter:1},images:{factor:1}},thresholds:{display:2e3,images:30}};test_heap_p=g;var h={event:{circle:{cx:-g.styles.events.diameter/2,cy:-g.styles.events.diameter/2,fill:function(a){return a.color||null},r:function(){return Math.min(10,g.zoom.factor)*g.styles.events.diameter/2}},transform:function(a){return"translate("+x(a[f].x)+","+y(a[f].y)+")"}}};return e.apply=function(){function e(){function a(){g.scales.axis=d3.time.scale().domain([g.scales.pxToDate(x.domain()[0]),g.scales.pxToDate(x.domain()[1])]).range([0,g.view.width]),g.axis=d3.svg.axis().scale(g.scales.axis).tickSize(g.view.height-g.view.padding).tickFormat(h.axis.tickFormat).orient("top"),g.elements.axis=g.svg.append("g").attr("class","heap_axis").attr("id","hs"+d+"_axis").call(g.axis).attr("transform","translate(0,"+(g.view.height-g.view.padding/2)+")")}function b(){g.elements.outline=g.svg.insert("g").attr("class","heap_outline").attr("id","hs"+d+"_outline").append("path"),g.elements.events=g.svg.insert("g").attr("class","heap_events").attr("id","hs"+d+"_events")}function c(){x=d3.scale.linear().domain([0,g.view.width]).range([0,g.view.width]),y=d3.scale.linear().domain([0,g.view.height]).range([0,g.view.height]),g.scales.dateToPx=d3.scale.linear().domain([g.view.from.valueOf(),g.view.to.valueOf()]).range([g.view.padding,g.view.width-g.view.padding]),g.scales.pxToDate=d3.scale.linear().domain([g.view.padding,g.view.width-g.view.padding]).range([g.view.from.valueOf(),g.view.to.valueOf()])}function e(){zoom=d3.behavior.zoom().x(x).y(y).scaleExtent(g.scales.minMax.zoom.domain()),g.svg.select(".heap_events").insert("rect",":first-child").attr("width",g.view.width).attr("height",g.view.height).attr("class","overlay"),g.svg.select(".heap_events").call(zoom.on("zoom",doZoom))}c(),b(),a(),e()}g.svg=arguments[0],g.view.width=+g.svg.attr("width"),g.view.height=+g.svg.attr("height"),console.log(g.view),b(),e(),c=!0,a()},e.data=function(d){return arguments.length?(g.data=d,g.data.forEach(function(a){a.hasOwnProperty(f)||(a[f]={})}),g.grid.initialised=!1,b(),c&&a(),e):g.data},e.update=function(){doZoom()},e.x=function(a){return arguments.length?(x=a,e):x},e.y=function(a){return arguments.length?(y=a,e):y},e.styles={},e.styles.events=function(b,c){if(arguments.length<2){if("string"==typeof b)return g.styles.events[b];if("object"==typeof b)for(var d in b)g.styles.events[d]=b[d]}else g.styles.events[b]=c;return g.grid.initialised=!1,a(),e},e.threshold=function(b,c){if(arguments.length<2){if("string"==typeof b)return g.thresholds[b];if("object"==typeof b)for(var d in b)g.thresholds[d]=b[d]}else g.thresholds[b]=c;return a(),e},e},TT.observer={addSubscriber:function(a){this.subscribers[this.subscribers.length]=a},removeSubscriber:function(a){for(var b=0;b<this.subscribers.length;b++)this.subscribers[b]===a&&delete this.subscribers[b]},publish:function(a){for(var b=0;b<this.subscribers.length;b++)"function"==typeof this.subscribers[b]&&this.subscribers[b](a)},make:function(a){for(var b in this)a[b]=this[b],a.subscribers=[]}},TT.timeline=function(){function a(){i.scales.axis.domain([i.scales.pxToDate(b.domain()[0]),i.scales.pxToDate(b.domain()[1])]),i.elements.axis.call(i.axis)}TT.timeline.id||(TT.timeline.id=0);var b,c,d,e=!1,f=TT.timeline.id++,g={},h="tl_"+f,i={axis:{},elements:{},format:{year:d3.time.format("%Y"),date:d3.time.format("%d %b %Y")},scales:{minMax:{zoom:d3.scale.linear().domain([.5,240]).range([0,1])}},view:{from:new Date(1900,0,1),to:new Date(2e3,0,1),width:800,height:600,padding:40}};test_timeline_p=i;var j={axis:{tickFormat:function(a){return Math.round((i.axis.scale().domain()[1].getFullYear()-i.axis.scale().domain()[0].getFullYear())/i.axis.ticks())>=1?i.format.year(a):i.format.date(a)}}};return g.apply=function(){function f(){function e(){i.scales.axis=d3.time.scale().domain([i.scales.pxToDate(b.domain()[0]),i.scales.pxToDate(b.domain()[1])]).range([0,i.view.width]),i.axis=d3.svg.axis().scale(i.scales.axis).tickSize(i.view.height-i.view.padding).tickFormat(j.axis.tickFormat).orient("top"),i.elements.axis=i.svg.append("g").attr("class","timeline_axis axis").attr("id",h+"_axis").call(i.axis).attr("transform","translate(0,"+(i.view.height-i.view.padding/2)+")")}function f(){b=d3.scale.linear().domain([0,i.view.width]).range([0,i.view.width]),c=d3.scale.linear().domain([0,i.view.height]).range([0,i.view.height]),i.scales.dateToPx=d3.scale.linear().domain([i.view.from.valueOf(),i.view.to.valueOf()]).range([i.view.padding,i.view.width-i.view.padding]),i.scales.pxToDate=d3.scale.linear().domain([i.view.padding,i.view.width-i.view.padding]).range([i.view.from.valueOf(),i.view.to.valueOf()])}function g(){d=d3.behavior.zoom().x(b).y(c).scaleExtent(i.scales.minMax.zoom.domain()),i.svg.insert("rect",":first-child").attr("width",i.view.width).attr("height",i.view.height).attr("class","overlay"),i.svg.select(".overlay").call(d.on("zoom",a))}f(),e(),g()}i.svg=arguments[0],i.view.width=+i.svg.attr("width"),i.view.height=+i.svg.attr("height"),f(),e=!0},g.refresh=function(){function a(){i.scales.axis.domain([i.scales.pxToDate(b.domain()[0]),i.scales.pxToDate(b.domain()[1])]).range([0,i.view.width]),i.axis.tickSize(i.view.height-i.view.padding),i.elements.axis.call(i.axis).attr("transform","translate(0,"+(i.view.height-i.view.padding/2)+")")}function d(){b.range([0,i.view.width]),c.range([0,i.view.height]),i.scales.dateToPx.domain([i.view.from.valueOf(),i.view.to.valueOf()]).range([i.view.padding,i.view.width-i.view.padding]),i.scales.pxToDate.domain([i.view.padding,i.view.width-i.view.padding]).range([i.view.from.valueOf(),i.view.to.valueOf()])}function e(){i.svg.attr("width",i.view.width),i.svg.attr("height",i.view.height)}function f(){i.svg.select(".overlay").attr("width",i.view.width).attr("height",i.view.height)}e(),d(),a(),f()},g.domain=function(a){return arguments.length?(2===a.length&&a[0]instanceof Date&&a[1]instanceof Date&&a[1]>a[0]&&(i.view.from=a[0],i.view.to=a[1]),g):Array(i.view.from,i.view.to)},g.height=function(a){return arguments.length?(i.view.height=a,g.refresh(),g):i.view.height},g.width=function(a){return arguments.length?(i.view.width=a,g.refresh(),g):i.view.width},g.x=function(a){return arguments.length?(b=a,g):b},g.y=function(a){return arguments.length?(c=a,g):c},g};