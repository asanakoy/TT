/*! TT 18-02-2014 */
var TT={version:"0.0.1"};TT.crossfilter=function(){function a(a){var c=(new d).dimension(a.dimension).group(a.group).title(a.title);c.x(a.isDate?d3.time.scale().domain([a.min,a.max]).rangeRound([0,l.view.width]):d3.scale.linear().domain([a.min,a.max]).rangeRound([0,l.view.width])),h.push(c),f.call(c),c.on("brush",b).on("brushend",b)}function b(){for(var a=0;a<h.length;a++)h[a].drawChart();c()}function c(){k.hasOwnProperty("publish")&&h[0]&&k.publish(h[0].dimension().top(999999))}function d(){function a(){o.on("brushstart.chart",function(){var a=d3.select(this.parentNode.parentNode.parentNode);a.select(".title a").style("display",null)}),o.on("brush.chart",function(){var a=d3.select(this.parentNode),b=o.extent();h&&a.select(".brush").call(o.extent(b=b.map(h))),a.select("#clip-"+l+" rect").attr("x",c(b[0])).attr("width",c(b[1])-c(b[0])),f.filterRange(b)}),o.on("brushend.chart",function(){if(o.empty()){var a=d3.select(this.parentNode.parentNode.parentNode);a.select(".title a").style("display","none"),a.select("#clip-"+l+" rect").attr("x",null).attr("width","100%"),f.filterAll()}})}d.id||(d.id=0);var b,c,e,f,g,h,i,j={},k=d3.scale.linear().range([100,0]),l=d.id++,m=d3.svg.axis().orient("bottom"),n=20,o=d3.svg.brush();return j.apply=function(){b=arguments[0],b=b.append("div").attr("id","barChart_"+l).attr("class","chart"),a(),j.drawChart()},j.drawChart=function(a){function d(a){for(var b,d=[],e=-1,f=a.length;++e<f;)b=a[e],d.push("M",c(b.key),",",j,"V",k(b.value),"h9V",j);return d.join("")}function f(){b.append("div").attr("class","title").text(i).append("a").attr("onclick","cf_reset("+l+")").attr("class","reset").text("reset").style("display","none"),p=b.append("svg").attr("width",h).attr("height",j+n).append("g"),p.append("clipPath").attr("id","clip-"+l).append("rect").attr("width",h).attr("height",j),p.selectAll(".bar").data(["background","foreground"]).enter().append("path").attr("class",function(a){return a+" bar"}).datum(g.all()),p.selectAll(".foreground.bar").attr("clip-path","url(#clip-"+l+")"),p.append("g").attr("class","axis").attr("transform","translate(0, "+j+")").call(m);var a=p.append("g").attr("class","brush").call(o);a.selectAll("rect").attr("height",j)}var h=c.range()[1],j=k.range()[0];k.domain([0,g.top(1)[0].value]);var p=b.select("g");if((p.empty()||a)&&f(),e)if(e=!1,p.selectAll(".brush").call(o),b.select(".title a").style("display",o.empty()?"none":null),o.empty())p.selectAll("#clip-"+l+" rect").attr("x",0).attr("width",h);else{var q=o.extent();p.selectAll("#clip-"+l+" rect").attr("x",c(q[0])).attr("width",c(q[1])-c(q[0]))}p.selectAll(".bar").attr("d",d)},j.redrawChart=function(){b.select("svg").remove(),b.select(".title").remove(),j.drawChart(!0)},j.dimension=function(a){return arguments.length?(f=a,j):f},j.filter=function(a){return a?(o.extent(a),f.filterRange(a)):(o.clear(),f.filterAll()),e=!0,j},j.group=function(a){return arguments.length?(g=a,j):g},j.round=function(a){return arguments.length?(h=a,j):h},j.title=function(a){return arguments.length?(i=a,j):i},j.x=function(a){return arguments.length?(c=a,m.scale(c),o.x(c),j):c},j.y=function(a){return arguments.length?(k=a,j):k},d3.rebind(j,o,"on")}TT.crossfilter.id||(TT.crossfilter.id=0);var e,f,g=crossfilter(),h=[],i=[],j=(TT.crossfilter.id++,!1),k={},l={view:{width:400,height:200}};return window.cf_reset=function(a){h[a].filter(null),b()},k.apply=function(){f=arguments[0];for(var b=0;b<i.length;b++)a(i[b]);j=!0},k.addFilter=function(b){var c={};if(c.title=b.title||b.dimension.toString(),"string"==typeof b.dimension)filterFunction=function(a){return a[b.dimension]};else{if("function"!=typeof b.dimension)return!1;filterFunction=b.dimension}return c.dimension=g.dimension(filterFunction),c.group=c.dimension.group(b.group),c.min=d3.min(e,filterFunction),c.max=d3.max(e,filterFunction),c.isDate=c.min instanceof Date,i.push(c),j&&a(c),k},k.forcePublish=function(){c()},k.charts=function(){return h},k.data=function(a){if(!arguments.length)return e;e=a,g.remove(),g.add(e);for(var b=0;b<h.length;b++)h[b].redrawChart();return c(),k},k.filters=function(){return i},k},TT.observer={addSubscriber:function(a){this.subscribers[this.subscribers.length]=a},removeSubscriber:function(a){for(var b=0;b<this.subscribers.length;b++)this.subscribers[b]===a&&delete this.subscribers[b]},publish:function(a){for(var b=0;b<this.subscribers.length;b++)"function"==typeof this.subscribers[b]&&this.subscribers[b](a)},make:function(a){for(var b in this)a[b]=this[b],a.subscribers=[]}},TT.timeline=function(){function a(){h.zoom.factor=d3.event.scale;var a=(h.elements.events.selectAll("g.timeline_event"),h.svg.select(".timeline_axis"));h.scales.axis.domain([h.scales.pxToDate(j.domain()[0]),h.scales.pxToDate(j.domain()[1])]),b(),a.call(h.axis)}function b(){function a(a){a.append("rect").attr("x",0).attr("y",0).attr("height",i.event.rect.height).attr("width",i.event.rect.width).attr("class","eventRect"),a.append("text").attr("class","title").text(function(a){return a.title}).attr("x",i.event.text.x).attr("y",i.event.text.y).attr("text-anchor",i.event.text.anchor).attr("display",i.event.text.display)}function b(a){return a.renderLevel>h.thresholds.display&&j(a.x)+a.width*h.zoom.factor>=0&&j(a.x)<=h.view.width&&a.y+k(0)>-h.styles.events.height&&a.y+k(0)<h.view.height}function c(){function a(a){return a.totalWorks?Math.pow(h.scales.minMax.works(a.totalWorks),.02/h.scales.minMax.zoom(h.zoom.factor))+h.scales.minMax.zoom(h.zoom.factor):0}h.data.forEach(function(b){b.renderLevel=a(b)});var b=0;h.data.forEach(function(a){a.renderLevel>h.thresholds.display&&(a.x=h.scales.dateToPx(a.from.valueOf()),a.width=h.scales.dateToPx(a.to.valueOf())-h.scales.dateToPx(a.from.valueOf()),a.height=a.renderLevel<h.thresholds.collapse?1:h.styles.events.height,a.margin=a.renderLevel<h.thresholds.collapse?1:h.styles.events.margin,a.y=0===b?h.view.padding:h.view.ys[b-1]+a.margin,h.view.ys[b]=a.y+a.height,b++)})}function d(a){a.select("rect.eventRect").attr("width",i.event.rect.width).attr("height",i.event.rect.height),a.select("text.title").attr("x",i.event.text.x).attr("y",i.event.text.y).attr("text-anchor",i.event.text.anchor).attr("display",i.event.text.display).style("font-size",i.event.text.fontSize)}if(!e)return!1;c();var g=h.elements.events.selectAll("g.timeline_event").data(h.data.filter(b),function(a){return a.id});g.attr("transform",i.event.transform),d(g);var l=g.enter().append("g").attr("id",function(a){return"tl"+f+"_event_"+a.id}).attr("class","timeline_event").attr("transform",i.event.transform);a(l),g.exit().remove()}function c(){h.scales.minMax.works.domain([d3.min(h.data,function(a){return a.totalWorks?a.totalWorks:0}),Math.min(300,d3.max(h.data,function(a){return a.totalWorks?a.totalWorks:0}))])}TT.timeline.id||(TT.timeline.id=0);var d,e=!1,f=TT.timeline.id++,g={},h={axis:{},data:[],elements:{},format:{year:d3.time.format("%Y"),date:d3.time.format("%d %b %Y")},scales:{minMax:{weight:d3.scale.linear().domain([0,1]).range([0,1]),works:d3.scale.linear().domain([0,1]).range([0,1]),zoom:d3.scale.linear().domain([.01,12]).range([0,1])}},styles:{events:{height:14,fontSize:12,margin:1,padding:2}},thresholds:{collapse:.99,display:.7},view:{from:new Date(1800,0,1),to:new Date(2020,0,1),width:800,height:600,padding:40,ys:[0]},zoom:{factor:1}},i={axis:{tickFormat:function(a){return Math.round((h.axis.scale().domain()[1].getFullYear()-h.axis.scale().domain()[0].getFullYear())/h.axis.ticks())>=1?h.format.year(a):h.format.date(a)}},event:{rect:{height:function(a){return Math.min(a.height*h.zoom.factor,a.height)+"px"},width:function(a){return a.width*h.zoom.factor+"px"}},text:{anchor:function(a){return h.zoom.factor>=h.thresholds.collapse&&a.width*h.zoom.factor>a.title.length*h.styles.events.fontSize?"start":"end"},display:function(a){return a.renderLevel>h.thresholds.collapse?"block":"none"},fontSize:h.styles.events.fontSize+"px",x:function(a){return a.width*h.zoom.factor>a.title.length*h.styles.events.fontSize?j(a.x)<0&&j(a.x)+a.width*h.zoom.factor>0?h.styles.events.padding+-1*j(a.x):h.styles.events.padding:-h.styles.events.padding},y:.75*h.styles.events.height},transform:function(a){return"translate("+j(a.x)+","+(a.y+k(0))+")"}}},j=d3.scale.linear().domain([0,h.view.width]).range([0,h.view.width]),k=d3.scale.linear().domain([0,h.view.height]).range([0,h.view.height]);return g.apply=function(){function g(){function b(){h.scales.axis=d3.time.scale().domain([h.scales.pxToDate(j.domain()[0]),h.scales.pxToDate(j.domain()[1])]).range([0,h.view.width]),h.axis=d3.svg.axis().scale(h.scales.axis).tickSize(h.view.height-h.view.padding).tickFormat(i.axis.tickFormat).orient("top"),h.elements.axis=h.svg.append("g").attr("class","timeline_axis").attr("id","tl"+f+"_axis").call(h.axis).attr("transform","translate(0,"+(h.view.height-h.view.padding/2)+")")}function c(){h.elements.events=h.svg.insert("g").attr("class","timeline_events").attr("id","tl"+f+"_events")}function e(){h.scales.dateToPx=d3.scale.linear().domain([h.view.from.valueOf(),h.view.to.valueOf()]).range([h.view.padding,h.view.width-h.view.padding]),h.scales.pxToDate=d3.scale.linear().domain([h.view.padding,h.view.width-h.view.padding]).range([h.view.from.valueOf(),h.view.to.valueOf()])}function g(){d=d3.behavior.zoom().x(j).y(k).scaleExtent(h.scales.minMax.zoom.domain()),h.svg.select(".timeline_events").insert("rect",":first-child").attr("width",h.view.width).attr("height",h.view.height).attr("class","overlay"),h.svg.select(".timeline_events").call(d.on("zoom",a))}e(),c(),b(),g()}if(h.svg=arguments[0],h.view.width=h.svg.attr("width"),h.view.height=h.svg.attr("height"),h.data){var l=d3.min(h.data,function(a){return a.from}),m=d3.max(h.data,function(a){return a.to});h.view.from=new Date(l.valueOf()-.2*(m.valueOf()-l.valueOf())),h.view.to=new Date(m.valueOf()+.2*(m.valueOf()-l.valueOf()))}g(),e=!0,c(),b()},g.data=function(a){return arguments.length?(h.data=a,c(),b(),g):h.data},g.styles={},g.styles.events=function(a,c){if(arguments.length<2){if("string"==typeof a)return h.styles.events[a];if("object"==typeof a)for(var d in a)h.styles.events[d]=a[d]}else h.styles.events[a]=c;return b(),g},g.threshold=function(a,c){if(arguments.length<2){if("string"==typeof a)return h.thresholds[a];if("object"==typeof a)for(var d in a)h.thresholds[d]=a[d]}else h.thresholds[a]=c;return b(),g},g};