/*! TT 28-03-2014 */
var TT={name:"Timeline Tools",author:{name:"Florian Kr√§utli",email:"florian@kraeutli.com",twitter:"@fkraeutli",url:"http://www.kraeutli.com"},version:"0.0.1"};TT.crossfilter=function(){function a(a){var c;switch(a.type){case f:c=(new d).dimension(a.dimension).group(a.group).title(a.title),c.x(a.isDate?d3.time.scale().domain([a.min,a.max]).rangeRound([0,q.view.width]):d3.scale.linear().domain([a.min,a.max]).rangeRound([0,q.view.width])),c.on("brush",b).on("brushend",b);break;case g:c=(new e).dimension(a.dimension).group(a.group).title(a.title);break;default:console.error("Invalid filter "+a.type)}return l.push(c),k.call(c),c}function b(){for(var a=0;a<l.length;a++)l[a].drawChart();c()}function c(){p.hasOwnProperty("publish")&&l.length&&(publishFrom=o||l[0],p.publish(publishFrom.dimension().top(1/0)))}function d(){function a(){s.on("brushstart.chart",function(){var a=d3.select(this.parentNode.parentNode.parentNode);a.select(".title a.reset").style("display","block")}),s.on("brush.chart",function(){var a=d3.select(this.parentNode),b=s.extent();i&&a.select(".brush").call(s.extent(b=b.map(i))),a.select("#clip-"+n+" rect").attr("x",e(b[0])).attr("width",e(b[1])-e(b[0])),g.filterRange(b)}),s.on("brushend.chart",function(){if(s.empty()){var a=d3.select(this.parentNode.parentNode.parentNode);a.select(".title a.reset").style("display","none"),a.select("#clip-"+n+" rect").attr("x",null).attr("width","100%"),g.filterAll()}})}var d,e,f,g,h,i,j,k={},m=d3.scale.linear().range([q.view.height,0]),n=l.length,p=d3.svg.axis().orient("bottom"),r=20,s=d3.svg.brush();return k.apply=function(){try{d=arguments[0]}catch(b){console.error("No DOM element specified")}d=d.append("div").attr("id","barChart_"+n).attr("class","chart barchart"),a(),k.drawChart()},k.drawChart=function(a){function b(a){for(var b,c=[],d=-1,f=a.length;++d<f;)b=a[d],c.push("M",e(b.key),",",i,"V",m(b.value),"h9V",i);return c.join("")}function c(){var a=d.append("div").attr("class","title").text(j);a.append("a").attr("class","reset").text("Reset").on("click",k.reset),a.append("a").attr("class","sort").text("Sort by").style("display",0===n?"none":"").on("click",function(){k.sortBy(n)}),l=d.append("svg").attr("width",g).attr("height",i+r).append("g"),l.append("clipPath").attr("id","clip-"+n).append("rect").attr("width",g).attr("height",i),l.selectAll(".bar").data(["background","foreground"]).enter().append("path").attr("class",function(a){return a+" bar"}).datum(h.all()),l.selectAll(".foreground.bar").attr("clip-path","url(#clip-"+n+")"),l.append("g").attr("class","axis").attr("transform","translate(0, "+i+")").call(p);var b=l.append("g").attr("class","brush").call(s);b.selectAll("rect").attr("height",i)}var g=e.range()[1],i=m.range()[0];m.domain([0,h.top(1)[0].value]);var l=d.select("g");if((l.empty()||a)&&c(),f)if(f=!1,l.selectAll(".brush").call(s),d.select(".title a.reset").style("display",s.empty()?"":"block"),s.empty())l.selectAll("#clip-"+n+" rect").attr("x",0).attr("width",g);else{var o=s.extent();l.selectAll("#clip-"+n+" rect").attr("x",e(o[0])).attr("width",e(o[1])-e(o[0]))}l.selectAll(".bar").attr("d",b)},k.reset=function(){l[n].filter(null),b()},k.redrawChart=function(){d.select("svg").remove(),d.select(".title").remove(),k.drawChart(!0)},k.sortBy=function(a){d3.selectAll(".title .sort").style("display","block"),d3.select("#barChart_"+a+" .sort").style("display","none"),o=l[a],c()},k.dimension=function(a){return arguments.length?(g=a,k):g},k.filter=function(a){return a?(s.extent(a),g.filterRange(a)):(s.clear(),g.filterAll()),f=!0,k},k.group=function(a){return arguments.length?(h=a,k):h},k.round=function(a){return arguments.length?(i=a,k):i},k.title=function(a){return arguments.length?(j=a,k):j},k.x=function(a){return arguments.length?(e=a,p.scale(e),s.x(e),k):e},k.y=function(a){return arguments.length?(m=a,k):m},d3.rebind(k,s,"on")}function e(){e.id||(e.id=0);var a,d,f,g,h=[],i={},j=l.length;return i.apply=function(){try{d=arguments[0]}catch(a){return console.error("No DOM element specified"),!1}d=d.append("div").attr("id","wordCloud_"+j).attr("class","chart wordCloud"),i.drawChart()},i.drawChart=function(c){function e(){var a=d.append("div").attr("class","title").text(g);a.append("a").attr("class","reset").text("Reset").on("click",i.reset),a.append("a").attr("class","sort").text("Sort by").style("display",0===j?"none":"").on("click",function(){i.sortBy(j)}),m=d.append("div").attr("width",l).attr("class","wordcloud_container")}function k(a){return-1!==h.indexOf(a)}var l=q.view.width,m=d.select("div.wordcloud_container");(m.empty()||c)&&e();var n=m.selectAll("span").data(f.all().filter(function(a){return a.value>0?a:void 0}),function(a){return a.key}).sort(function(a,b){return b.key<a.key}),o=n.enter(),p=n.exit(),r=d3.scale.linear().domain([0,Math.min(d3.max(f.all(),function(a){return a.value}),10)]).range([0,1]);words_attributes={fontSize:function(a){return 9*Math.min(r(a.value),1)+8+"px"}},n.style("font-size",words_attributes.fontSize),o.append("span").text(function(a){return a.key}).style("font-size",words_attributes.fontSize).attr("class",function(a){return"term term_"+a.key+" "+(-1!==h.indexOf(a.key)?"selected":"")}).on("click",function(c){-1===h.indexOf(c.key)?(h.push(c.key),d3.select(this).classed("selected",1)):(h.splice(h.indexOf(c.key),1),d3.select(this).classed("selected",0)),h.length?(a.filterFunction(k),d3.select(this.parentNode).classed("filtered",1),d.select(".title a.reset").style("display","block")):i.reset(),b()}),p.remove()},i.redrawChart=function(){d.select("div.wordcloud_container").remove(),d.select(".title").remove(),i.drawChart(!0)},i.reset=function(){h=[],a.filterAll(),d.selectAll(".term").style("color",""),d.select(".filtered").classed("filtered",0),d.selectAll(".selected").classed("selected",0),d.select(".title a.reset").style("display",null),b()},i.sortBy=function(a){console.log("Hello"+a),d3.selectAll(".title .sort").style("display","block"),d3.select("#wordCloud_"+a+" .sort").style("display","none"),o=l[a],c()},i.dimension=function(b){return arguments.length?(a=b,i):a},i.group=function(a){return arguments.length?(f=a,i):f},i.title=function(a){return arguments.length?(g=a,i):g},i}var f="continuous",g="tags",h="unique";TT.crossfilter.id||(TT.crossfilter.id=0);var i,j,k,l=[],m=[],n=(TT.crossfilter.id++,!1),o=!1,p={},q={view:{width:400,height:30}};try{i=crossfilter(),test_cf=i}catch(r){return console.error("Crossfilter is not loaded. Get Crossfilter from http://square.github.io/crossfilter/"),!1}return p.apply=function(){k=arguments[0];for(var b=0;b<m.length;b++)a(m[b]);n=!0},p.addFilter=function(b){var c={};c.title=b.title||b.dimension.toString();var d;d="function"==typeof b.dimension?b.dimension:function(a){return a[b.dimension]},c.dimension=i.dimension(d),c.group=c.dimension.group(b.group?b.group:function(a){return a}),c.min=d3.min(j,d),c.max=d3.max(j,d),c.isDate=c.min instanceof Date;for(var e=!0,k=c.group.all(),l=0;l<k.length;l++)if(isNaN(+k[l].key.valueOf())){e=!1;break}return c.type=e?f:c.group.all().length==c.dimension.top(1/0).length?h:g,m.push(c),n&&a(c),p},p.forcePublish=function(){c()},p.charts=function(){return l},p.data=function(a){if(!arguments.length)return j;j=a,i.remove(),i.add(j);for(var b=0;b<l.length;b++)l[b].redrawChart();return c(),p},p.filters=function(){return m},p},String.prototype.ucfirst=function(){return this.charAt(0).toUpperCase()+this.slice(1)},TT.heap=function(){function a(){d3.event&&(i.zoom.factor=d3.event.scale);var a=i.svg.select(".heap_axis");i.scales.axis.domain([i.scales.pxToDate(k.domain()[0]),i.scales.pxToDate(k.domain()[1])]),b(),a.call(i.axis)}function b(){function a(a){a.append("circle").attr("class","eventCircle").attr("cx",j.event.circle.cx).attr("cy",j.event.circle.cy).attr("r",j.event.circle.r).style("fill",j.event.circle.fill),g(a)}function b(a){return k(a[h].x)>=0&&k(a[h].x)<=i.view.width&&l(a[h].y)>-i.styles.events.diameter&&l(a[h].y)<i.view.height}function c(){function a(){function a(a){if(i.grid.table[a[h].col][a[h].row].length<=1)return!1;var b=a[h].initCol,d=a[h].row+1;i.grid.table[b][d]||c(b,d);var e=i.grid.table[b][d].length;if(a[h].candidateCols)for(var f=0;f<a[h].candidateCols.length;f++){var g=a[h].candidateCols[f];if(0===e)break;var j,k=!1;i.grid.table[g][a[h].row]?j=i.grid.table[g][a[h].row].length:(c(g,a[h].row),j=0,k=!0),(k||e>j&&-1==a[h].trace.indexOf(parseFloat(g+"."+a[h].row)))&&(e=j,b=g,d=a[h].row)}for(var l=0;l<i.grid.table[a[h].col][a[h].row].length;l++)if(i.grid.table[a[h].col][a[h].row][l]==a){i.grid.table[a[h].col][a[h].row].splice(l,1);break}a[h].col=b,a[h].row=d,a[h].trace.push(parseFloat(a[h].col+"."+a[h].row)),i.grid.table[a[h].col][a[h].row].push(a)}function b(){for(var a=0;a<i.grid.table.length;a++)for(var b=0;b<i.grid.table[a].length;b++)if(i.grid.table[a][b].length>1)return!1;return!0}for(var d=0,e=.1*i.data.length;!b()&&e>d;)i.data.forEach(a),d++}function b(){i.grid.availableWidth=i.scales.dateToPx(i.view.to)-i.scales.dateToPx(i.view.from),i.grid.numCols=Math.floor(i.grid.availableWidth/i.styles.events.diameter),i.grid.range=i.view.to-i.view.from,i.grid.resolution=i.grid.range/i.grid.numCols,i.grid.colWidth=i.styles.events.diameter,i.grid.table=[];for(var a=0;a<i.grid.numCols;a++)i.grid.table[a]=Array(),i.grid.table[a][0]=Array();i.grid.numRows=1,i.data.forEach(function(a){a[h].trace=a[h].trace||Array(),a[h].col=a[h].initCol=Math.min(Math.floor((a.from.valueOf()+(a.to.valueOf()-a.from.valueOf())/2-i.view.from.valueOf())/i.grid.resolution),i.grid.numCols-1),a[h].row=0,a[h].trace.push(parseFloat(a[h].col+"."+a[h].row)),a[h].minCol=Math.max(Math.floor((a.from.valueOf()-i.view.from.valueOf())/i.grid.resolution),0),a[h].maxCol=Math.min(Math.ceil((a.to.valueOf()-i.view.from.valueOf())/i.grid.resolution),i.grid.numCols-1),a[h].maxCol>a[h].initCol&&(a[h].candidateCols=d3.range(a[h].initCol,a[h].minCol).concat(d3.range(a[h].initCol+1,a[h].maxCol)));try{i.grid.table[a[h].col][a[h].row].push(a)}catch(b){console.log(a)}})}function c(a,b){for(var c=i.grid.table[a].length;b>=c;c++)i.grid.table[a][c]=Array()}return i.grid.initialised?!1:(b(),a(),i.data.forEach(function(a){a[h].x=i.scales.dateToPx(a[h].col*i.grid.resolution+i.view.from.valueOf());var b=i.grid.table[a[h].col].length*i.styles.events.diameter/2+i.view.height/2;a[h].y=-a[h].row*i.styles.events.diameter+b-b%i.styles.events.diameter}),void(i.grid.initialised=!0))}function d(a){a.select("circle.eventCircle").attr("r",j.event.circle.r).style("fill",j.event.circle.fill),g(a)}function g(a){i.zoom.factor>10?(a.filter(function(a){return!a.hasImage&&a.thumbnailUrl}).append("image").attr("xlink:href",function(a){return a.hasImage=!0,a.thumbnailUrl}),a.selectAll("image").attr("x",-i.zoom.factor/2).attr("y",-i.zoom.factor/2).attr("width",i.zoom.factor+"px").attr("height",i.zoom.factor+"px")):(a.selectAll("image").remove(),a.each(function(a){a.hasImage=!1}))}if(!e)return!1;c();var m=i.elements.events.selectAll("g.heap_event").data(i.data.filter(b),function(a){return a.id}),n=m.enter().append("g").attr("id",function(a){return"hp"+f+"_event_"+a.id}).attr("class","heap_event").attr("transform",j.event.transform).on("click",function(a){console.log(a)}).each(function(a){a.hasImage=!1});a(n),m.attr("transform",j.event.transform),d(m),m.exit().remove()}function c(){if(i.data){var a=d3.min(i.data,function(a){return a.from}),b=d3.max(i.data,function(a){return a.to});i.view.from=a,i.view.to=b}}TT.heap.id||(TT.heap.id=0);var d,e=!1,f=TT.heap.id++,g={},h="hp_"+f,i={axis:{},data:[],elements:{},format:{year:d3.time.format("%Y"),date:d3.time.format("%d %b %Y")},grid:{availableWidth:null,numCols:null,numRows:1,initialised:!1,range:null,resolution:null,table:[]},scales:{minMax:{zoom:d3.scale.linear().domain([.9,240]).range([0,1])}},styles:{events:{diameter:1}},view:{from:new Date(1900,0,1),to:new Date(2e3,0,1),width:800,height:600,padding:40},zoom:{factor:1}};test_heap_p=i;var j={axis:{tickFormat:function(a){return Math.round((i.axis.scale().domain()[1].getFullYear()-i.axis.scale().domain()[0].getFullYear())/i.axis.ticks())>=1?i.format.year(a):i.format.date(a)}},event:{circle:{cx:-i.styles.events.diameter/2,cy:-i.styles.events.diameter/2,fill:function(a){return a.color||null},r:function(){return Math.min(10,i.zoom.factor)*i.styles.events.diameter/2}},transform:function(a){return"translate("+k(a[h].x)+","+l(a[h].y)+")"}}},k=d3.scale.linear().domain([0,i.view.width]).range([0,i.view.width]),l=d3.scale.linear().domain([0,i.view.height]).range([0,i.view.height]);return g.apply=function(){function g(){function b(){i.scales.axis=d3.time.scale().domain([i.scales.pxToDate(k.domain()[0]),i.scales.pxToDate(k.domain()[1])]).range([0,i.view.width]),i.axis=d3.svg.axis().scale(i.scales.axis).tickSize(i.view.height-i.view.padding).tickFormat(j.axis.tickFormat).orient("top"),i.elements.axis=i.svg.append("g").attr("class","heap_axis").attr("id","hp"+f+"_axis").call(i.axis).attr("transform","translate(0,"+(i.view.height-i.view.padding/2)+")")}function c(){i.elements.events=i.svg.insert("g").attr("class","heap_events").attr("id","hp"+f+"_events")}function e(){i.scales.dateToPx=d3.scale.linear().domain([i.view.from.valueOf(),i.view.to.valueOf()]).range([i.view.padding,i.view.width-i.view.padding]),i.scales.pxToDate=d3.scale.linear().domain([i.view.padding,i.view.width-i.view.padding]).range([i.view.from.valueOf(),i.view.to.valueOf()])}function g(){d=d3.behavior.zoom().x(k).y(l).scaleExtent(i.scales.minMax.zoom.domain()),i.svg.select(".heap_events").insert("rect",":first-child").attr("width",i.view.width).attr("height",i.view.height).attr("class","overlay"),i.svg.select(".heap_events").call(d.on("zoom",a))}e(),c(),b(),g()}i.svg=arguments[0],i.view.width=+i.svg.attr("width"),i.view.height=+i.svg.attr("height"),c(),g(),e=!0,b()},g.data=function(a){return arguments.length?(i.data=a,i.data.forEach(function(a){a.hasOwnProperty(h)||(a[h]={})}),i.grid.initialised=!1,c(),e&&b(),g):i.data},g.update=function(){a()},g.x=function(a){return arguments.length?(k=a,g):k},g.y=function(a){return arguments.length?(l=a,g):l},g.styles={},g.styles.events=function(a,c){if(arguments.length<2){if("string"==typeof a)return i.styles.events[a];if("object"==typeof a)for(var d in a)i.styles.events[d]=a[d]}else i.styles.events[a]=c;return b(),g},g.threshold=function(a,c){if(arguments.length<2){if("string"==typeof a)return i.thresholds[a];if("object"==typeof a)for(var d in a)i.thresholds[d]=a[d]}else i.thresholds[a]=c;return b(),g},g},TT.histogram=function(){function a(){d3.event&&(i.zoom.factor=d3.event.scale);var a=i.svg.select(".histogram_axis");i.scales.axis.domain([i.scales.pxToDate(k.domain()[0]),i.scales.pxToDate(k.domain()[1])]),b(),a.call(i.axis)}function b(){function a(a){a.append("circle").attr("class","eventCircle").attr("cx",j.event.circle.cx).attr("cy",j.event.circle.cy).attr("r",j.event.circle.r).style("fill",j.event.circle.fill),g(a)}function b(a){return k(a[h].x)>=0&&k(a[h].x)<=i.view.width&&l(a[h].y)>-i.styles.events.diameter&&l(a[h].y)<i.view.height}function c(){function a(){function a(a){if(i.grid.table[a[h].col][a[h].row].length<=1)return!1;var b=a[h].initCol,d=a[h].row+1;i.grid.table[b][d]||c(b,d);var e=i.grid.table[b][d].length;if(a[h].candidateCols)for(var f=0;f<a[h].candidateCols.length;f++){var g=a[h].candidateCols[f];if(0===e)break;var j,k=!1;i.grid.table[g][a[h].row]?j=i.grid.table[g][a[h].row].length:(c(g,a[h].row),j=0,k=!0),(k||e>j&&-1==a[h].trace.indexOf(parseFloat(g+"."+a[h].row)))&&(e=j,b=g,d=a[h].row)}for(var l=0;l<i.grid.table[a[h].col][a[h].row].length;l++)if(i.grid.table[a[h].col][a[h].row][l]==a){i.grid.table[a[h].col][a[h].row].splice(l,1);break}a[h].col=b,a[h].row=d,a[h].trace.push(parseFloat(a[h].col+"."+a[h].row)),i.grid.table[a[h].col][a[h].row].push(a)}function b(){for(var a=0;a<i.grid.table.length;a++)for(var b=0;b<i.grid.table[a].length;b++)if(i.grid.table[a][b].length>1)return!1;return!0}for(var d=0,e=.1*i.data.length;!b()&&e>d;)i.data.forEach(a),d++}function b(){i.grid.availableWidth=i.scales.dateToPx(i.view.to)-i.scales.dateToPx(i.view.from),i.grid.numCols=Math.floor(i.grid.availableWidth/i.styles.events.diameter),i.grid.range=i.view.to-i.view.from,i.grid.resolution=i.grid.range/i.grid.numCols,i.grid.colWidth=i.styles.events.diameter,i.grid.table=[];for(var a=0;a<i.grid.numCols;a++)i.grid.table[a]=Array(),i.grid.table[a][0]=Array();i.grid.numRows=1,i.data.forEach(function(a){a[h].trace=a[h].trace||Array(),a[h].col=a[h].initCol=Math.min(Math.floor((a.from.valueOf()+(a.to.valueOf()-a.from.valueOf())/2-i.view.from.valueOf())/i.grid.resolution),i.grid.numCols-1),a[h].row=0,a[h].trace.push(parseFloat(a[h].col+"."+a[h].row)),a[h].minCol=Math.max(Math.floor((a.from.valueOf()-i.view.from.valueOf())/i.grid.resolution),0),a[h].maxCol=Math.min(Math.ceil((a.to.valueOf()-i.view.from.valueOf())/i.grid.resolution),i.grid.numCols-1),a[h].maxCol>a[h].initCol&&(a[h].candidateCols=d3.range(a[h].initCol,a[h].minCol).concat(d3.range(a[h].initCol+1,a[h].maxCol)));try{i.grid.table[a[h].col][a[h].row].push(a)}catch(b){console.log(a)}})}function c(a,b){for(var c=i.grid.table[a].length;b>=c;c++)i.grid.table[a][c]=Array()}return i.grid.initialised?!1:(b(),a(),i.data.forEach(function(a){a[h].x=i.scales.dateToPx(a[h].col*i.grid.resolution+i.view.from.valueOf());var b=i.grid.table[a[h].col].length*i.styles.events.diameter/2+i.view.height/2;a[h].y=-a[h].row*i.styles.events.diameter+b-b%i.styles.events.diameter}),void(i.grid.initialised=!0))}function d(a){a.select("circle.eventCircle").attr("r",j.event.circle.r).style("fill",j.event.circle.fill),g(a)}function g(a){i.zoom.factor>10?(a.filter(function(a){return!a.hasImage&&a.thumbnailUrl}).append("image").attr("xlink:href",function(a){return a.hasImage=!0,a.thumbnailUrl}),a.selectAll("image").attr("x",-i.zoom.factor/2).attr("y",-i.zoom.factor/2).attr("width",i.zoom.factor+"px").attr("height",i.zoom.factor+"px")):(a.selectAll("image").remove(),a.each(function(a){a.hasImage=!1}))}if(!e)return!1;c();var m=i.elements.events.selectAll("g.histogram_event").data(i.data.filter(b),function(a){return a.id}),n=m.enter().append("g").attr("id",function(a){return"hs"+f+"_event_"+a.id}).attr("class","histogram_event").attr("transform",j.event.transform).on("click",function(a){console.log(a)}).each(function(a){a.hasImage=!1});a(n),m.attr("transform",j.event.transform),d(m),m.exit().remove()}function c(){if(i.data){var a=d3.min(i.data,function(a){return a.from}),b=d3.max(i.data,function(a){return a.to});i.view.from=a,i.view.to=b}}TT.histogram.id||(TT.histogram.id=0);var d,e=!1,f=TT.histogram.id++,g={},h="hs_"+f,i={axis:{},data:[],elements:{},format:{year:d3.time.format("%Y"),date:d3.time.format("%d %b %Y")},grid:{availableWidth:null,numCols:null,numRows:1,initialised:!1,range:null,resolution:null,table:[]},scales:{minMax:{zoom:d3.scale.linear().domain([.9,240]).range([0,1])}},styles:{events:{diameter:1}},view:{from:new Date(1900,0,1),to:new Date(2e3,0,1),width:800,height:600,padding:40},zoom:{factor:1}};test_histogram_p=i;var j={axis:{tickFormat:function(a){return Math.round((i.axis.scale().domain()[1].getFullYear()-i.axis.scale().domain()[0].getFullYear())/i.axis.ticks())>=1?i.format.year(a):i.format.date(a)}},event:{circle:{cx:-i.styles.events.diameter/2,cy:-i.styles.events.diameter/2,fill:function(a){return a.color||null},r:function(){return Math.min(10,i.zoom.factor)*i.styles.events.diameter/2}},transform:function(a){return"translate("+k(a[h].x)+","+l(a[h].y)+")"}}},k=d3.scale.linear().domain([0,i.view.width]).range([0,i.view.width]),l=d3.scale.linear().domain([0,i.view.height]).range([0,i.view.height]);return g.apply=function(){function g(){function b(){i.scales.axis=d3.time.scale().domain([i.scales.pxToDate(k.domain()[0]),i.scales.pxToDate(k.domain()[1])]).range([0,i.view.width]),i.axis=d3.svg.axis().scale(i.scales.axis).tickSize(i.view.height-i.view.padding).tickFormat(j.axis.tickFormat).orient("top"),i.elements.axis=i.svg.append("g").attr("class","histogram_axis").attr("id","hs"+f+"_axis").call(i.axis).attr("transform","translate(0,"+(i.view.height-i.view.padding/2)+")")}function c(){i.elements.events=i.svg.insert("g").attr("class","histogram_events").attr("id","hs"+f+"_events")}function e(){i.scales.dateToPx=d3.scale.linear().domain([i.view.from.valueOf(),i.view.to.valueOf()]).range([i.view.padding,i.view.width-i.view.padding]),i.scales.pxToDate=d3.scale.linear().domain([i.view.padding,i.view.width-i.view.padding]).range([i.view.from.valueOf(),i.view.to.valueOf()])}function g(){d=d3.behavior.zoom().x(k).y(l).scaleExtent(i.scales.minMax.zoom.domain()),i.svg.select(".histogram_events").insert("rect",":first-child").attr("width",i.view.width).attr("height",i.view.height).attr("class","overlay"),i.svg.select(".histogram_events").call(d.on("zoom",a))}e(),c(),b(),g()}i.svg=arguments[0],i.view.width=+i.svg.attr("width"),i.view.height=+i.svg.attr("height"),c(),g(),e=!0,b()},g.data=function(a){return arguments.length?(i.data=a,i.data.forEach(function(a){a.hasOwnProperty(h)||(a[h]={})}),i.grid.initialised=!1,c(),e&&b(),g):i.data},g.update=function(){a()},g.x=function(a){return arguments.length?(k=a,g):k},g.y=function(a){return arguments.length?(l=a,g):l},g.styles={},g.styles.events=function(a,c){if(arguments.length<2){if("string"==typeof a)return i.styles.events[a];if("object"==typeof a)for(var d in a)i.styles.events[d]=a[d]}else i.styles.events[a]=c;return b(),g},g.threshold=function(a,c){if(arguments.length<2){if("string"==typeof a)return i.thresholds[a];if("object"==typeof a)for(var d in a)i.thresholds[d]=a[d]}else i.thresholds[a]=c;return b(),g},g},TT.observer={addSubscriber:function(a){this.subscribers[this.subscribers.length]=a},removeSubscriber:function(a){for(var b=0;b<this.subscribers.length;b++)this.subscribers[b]===a&&delete this.subscribers[b]},publish:function(a){for(var b=0;b<this.subscribers.length;b++)"function"==typeof this.subscribers[b]&&this.subscribers[b](a)},make:function(a){for(var b in this)a[b]=this[b],a.subscribers=[]}},TT.timeline=function(){function a(){i.zoom.factor=d3.event.scale;var a=(i.elements.events.selectAll("g.timeline_event"),i.svg.select(".timeline_axis"));i.scales.axis.domain([i.scales.pxToDate(k.domain()[0]),i.scales.pxToDate(k.domain()[1])]),b(),a.call(i.axis)}function b(){function a(a){a.append("rect").attr("class","eventRect").attr("x",0).attr("y",0).attr("height",j.event.rect.height).attr("width",j.event.rect.width).style("fill",j.event.rect.fill),a.append("text").attr("class","title").text(function(a){return a.title}).attr("x",j.event.text.x).attr("y",j.event.text.y).attr("text-anchor",j.event.text.anchor).attr("display",j.event.text.display)}function b(a){return a[g].renderLevel>=i.thresholds.display&&k(a[g].x)+a[g].width*i.zoom.factor>=0&&k(a[g].x)<=i.view.width&&a[g].y+l(0)>-i.styles.events.height&&a[g].y+l(0)<i.view.height}function c(){function a(a){return a.weight?Math.pow(i.scales.minMax.works(a.weight),.02/i.scales.minMax.zoom(i.zoom.factor))+i.scales.minMax.zoom(i.zoom.factor):0}i.data.forEach(function(b){b[g].renderLevel=a(b)}),(1==i.data.length||d3.min(i.data,function(a){return a[g].renderLevel})==d3.max(i.data,function(a){return a[g].renderLevel}))&&i.data.forEach(function(a){a[g].renderLevel=1});var b=0;i.data.forEach(function(a){a[g].renderLevel>i.thresholds.display&&(a[g].x=i.scales.dateToPx(a.from.valueOf()),a[g].width=i.scales.dateToPx(a.to.valueOf())-i.scales.dateToPx(a.from.valueOf()),a[g].height=a[g].renderLevel<i.thresholds.collapse?i.styles.events.collapsedHeight:i.styles.events.height,a[g].margin=a[g].renderLevel<i.thresholds.collapse?i.styles.events.collapsedMargin:i.styles.events.margin,a[g].y=0===b?i.view.padding:i.view.ys[b-1]+a[g].margin,i.view.ys[b]=a[g].y+a[g].height,b++)})}function d(a){a.select("rect.eventRect").attr("width",j.event.rect.width).attr("height",j.event.rect.height).style("fill",j.event.rect.fill),a.select("text.title").attr("x",j.event.text.x).attr("y",j.event.text.y).attr("text-anchor",j.event.text.anchor).attr("display",j.event.text.display).style("font-size",j.event.text.fontSize)}if(!e)return!1;c();var h=i.elements.events.selectAll("g.timeline_event").data(i.data.filter(b),function(a){return a.id});h.attr("transform",j.event.transform),d(h);var m=h.enter().append("g").attr("id",function(a){return"tl"+f+"_event_"+a.id}).attr("class","timeline_event").attr("transform",j.event.transform).on("click",function(a){console.log(a)});a(m),h.exit().remove()}function c(){i.scales.minMax.works.domain([d3.min(i.data,function(a){return a.weight?a.weight:0}),Math.min(300,d3.max(i.data,function(a){return a.weight?a.weight:0}))])}TT.timeline.id||(TT.timeline.id=0);var d,e=!1,f=TT.timeline.id++,g="tl_"+f,h={},i={axis:{},data:[],elements:{},format:{year:d3.time.format("%Y"),date:d3.time.format("%d %b %Y")},scales:{minMax:{weight:d3.scale.linear().domain([0,1]).range([0,1]),works:d3.scale.linear().domain([0,1]).range([0,1]),zoom:d3.scale.linear().domain([.01,120]).range([0,1])}},styles:{events:{height:12,collapsedHeight:2,fontSize:12,margin:1,collapsedMargin:1,padding:2}},thresholds:{collapse:.6,display:.2},view:{from:new Date(1900,0,1),to:new Date(2e3,0,1),width:800,height:600,padding:40,ys:[0]},zoom:{factor:1}},j={axis:{tickFormat:function(a){return Math.round((i.axis.scale().domain()[1].getFullYear()-i.axis.scale().domain()[0].getFullYear())/i.axis.ticks())>=1?i.format.year(a):i.format.date(a)}},event:{rect:{fill:function(a){return a.color||null},height:function(a){return Math.min(a[g].height*i.zoom.factor,a[g].height)+"px"},width:function(a){return a[g].width*i.zoom.factor+"px"}},text:{anchor:function(a){return i.zoom.factor>=i.thresholds.collapse&&a[g].width*i.zoom.factor>a.title.length*i.styles.events.fontSize?"start":"end"},display:function(a){return a[g].renderLevel>i.thresholds.collapse?"block":"none"},fontSize:i.styles.events.fontSize+"px",x:function(a){return a[g].width*i.zoom.factor>a.title.length*i.styles.events.fontSize?k(a[g].x)<0&&k(a[g].x)+a[g].width*i.zoom.factor>0?i.styles.events.padding+-1*k(a[g].x):i.styles.events.padding:-i.styles.events.padding},y:.75*i.styles.events.height},transform:function(a){return"translate("+k(a[g].x)+","+(a[g].y+l(0))+")"}}},k=d3.scale.linear().domain([0,i.view.width]).range([0,i.view.width]),l=d3.scale.linear().domain([0,i.view.height]).range([0,i.view.height]);return h.apply=function(){function g(){function b(){i.scales.axis=d3.time.scale().domain([i.scales.pxToDate(k.domain()[0]),i.scales.pxToDate(k.domain()[1])]).range([0,i.view.width]),i.axis=d3.svg.axis().scale(i.scales.axis).tickSize(i.view.height-i.view.padding).tickFormat(j.axis.tickFormat).orient("top"),i.elements.axis=i.svg.append("g").attr("class","timeline_axis").attr("id","tl"+f+"_axis").call(i.axis).attr("transform","translate(0,"+(i.view.height-i.view.padding/2)+")")}function c(){i.elements.events=i.svg.insert("g").attr("class","timeline_events").attr("id","tl"+f+"_events")}function e(){i.scales.dateToPx=d3.scale.linear().domain([i.view.from.valueOf(),i.view.to.valueOf()]).range([i.view.padding,i.view.width-i.view.padding]),i.scales.pxToDate=d3.scale.linear().domain([i.view.padding,i.view.width-i.view.padding]).range([i.view.from.valueOf(),i.view.to.valueOf()])}function g(){d=d3.behavior.zoom().x(k).y(l).scaleExtent(i.scales.minMax.zoom.domain()),i.svg.select(".timeline_events").insert("rect",":first-child").attr("width",i.view.width).attr("height",i.view.height).attr("class","overlay"),i.svg.select(".timeline_events").call(d.on("zoom",a))}e(),c(),b(),g()}if(i.svg=arguments[0],i.view.width=i.svg.attr("width"),i.view.height=i.svg.attr("height"),i.data){var h=d3.min(i.data,function(a){return a.from}),m=d3.max(i.data,function(a){return a.to});i.view.from=new Date(h.valueOf()-.2*(m.valueOf()-h.valueOf())),i.view.to=new Date(m.valueOf()+.2*(m.valueOf()-h.valueOf()))}g(),e=!0,c(),b()},h.data=function(a){return arguments.length?(i.data=a,i.data.forEach(function(a){a.hasOwnProperty(g)||(a[g]={})}),c(),b(),h):i.data},h.x=function(a){return arguments.length?(k=a,h):k},h.y=function(a){return arguments.length?(l=a,h):l},h.styles={},h.styles.events=function(a,c){if(arguments.length<2){if("string"==typeof a)return i.styles.events[a];if("object"==typeof a)for(var d in a)i.styles.events[d]=a[d]}else i.styles.events[a]=c;return b(),h},h.threshold=function(a,c){if(arguments.length<2){if("string"==typeof a)return i.thresholds[a];if("object"==typeof a)for(var d in a)i.thresholds[d]=a[d]}else i.thresholds[a]=c;return b(),h},h};