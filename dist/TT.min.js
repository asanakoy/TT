/*! TT 14-04-2014 */
var TT={name:"Timeline Tools",author:{name:"Florian Kr√§utli",email:"florian@kraeutli.com",twitter:"@fkraeutli",url:"http://www.kraeutli.com"},version:"0.0.1"};TT.crossfilter=function(){function a(a){var c;switch(a.type){case f:c=(new d).dimension(a.dimension).group(a.group).title(a.title),c.x(a.isDate?d3.time.scale().domain([a.min,a.max]).rangeRound([0,q.view.width]):d3.scale.linear().domain([a.min,a.max]).rangeRound([0,q.view.width])),c.on("brush",b).on("brushend",b);break;case g:c=(new e).dimension(a.dimension).group(a.group).title(a.title);break;default:console.error("Invalid filter "+a.type)}return l.push(c),k.call(c),c}function b(){for(var a=0;a<l.length;a++)l[a].drawChart();c()}function c(){p.hasOwnProperty("publish")&&l.length&&(publishFrom=o||l[0],p.publish(publishFrom.dimension().top(1/0)))}function d(){function a(){s.on("brushstart.chart",function(){var a=d3.select(this.parentNode.parentNode.parentNode);a.select(".title a.reset").style("display","block")}),s.on("brush.chart",function(){var a=d3.select(this.parentNode),b=s.extent();i&&a.select(".brush").call(s.extent(b=b.map(i))),a.select("#clip-"+n+" rect").attr("x",e(b[0])).attr("width",e(b[1])-e(b[0])),g.filterRange(b)}),s.on("brushend.chart",function(){if(s.empty()){var a=d3.select(this.parentNode.parentNode.parentNode);a.select(".title a.reset").style("display","none"),a.select("#clip-"+n+" rect").attr("x",null).attr("width","100%"),g.filterAll()}})}var d,e,f,g,h,i,j,k={},m=d3.scale.linear().range([q.view.height,0]),n=l.length,p=d3.svg.axis().orient("bottom"),r=20,s=d3.svg.brush();return k.apply=function(){try{d=arguments[0]}catch(b){console.error("No DOM element specified")}d=d.append("div").attr("id","barChart_"+n).attr("class","chart barchart"),a(),k.drawChart()},k.drawChart=function(a){function b(a){for(var b,c=[],d=-1,f=a.length;++d<f;)b=a[d],c.push("M",e(b.key),",",i,"V",m(b.value),"h9V",i);return c.join("")}function c(){var a=d.append("div").attr("class","title").text(j);a.append("a").attr("class","reset").text("Reset").on("click",k.reset),a.append("a").attr("class","sort").text("Sort by").style("display",0===n?"none":"").on("click",function(){k.sortBy(n)}),l=d.append("svg").attr("width",g).attr("height",i+r).append("g"),l.append("clipPath").attr("id","clip-"+n).append("rect").attr("width",g).attr("height",i),l.selectAll(".bar").data(["background","foreground"]).enter().append("path").attr("class",function(a){return a+" bar"}).datum(h.all()),l.selectAll(".foreground.bar").attr("clip-path","url(#clip-"+n+")"),l.append("g").attr("class","axis").attr("transform","translate(0, "+i+")").call(p);var b=l.append("g").attr("class","brush").call(s);b.selectAll("rect").attr("height",i)}var g=e.range()[1],i=m.range()[0];m.domain([0,h.top(1)[0].value]);var l=d.select("g");if((l.empty()||a)&&c(),f)if(f=!1,l.selectAll(".brush").call(s),d.select(".title a.reset").style("display",s.empty()?"":"block"),s.empty())l.selectAll("#clip-"+n+" rect").attr("x",0).attr("width",g);else{var o=s.extent();l.selectAll("#clip-"+n+" rect").attr("x",e(o[0])).attr("width",e(o[1])-e(o[0]))}l.selectAll(".bar").attr("d",b)},k.reset=function(){l[n].filter(null),b()},k.redrawChart=function(){d.select("svg").remove(),d.select(".title").remove(),k.drawChart(!0)},k.sortBy=function(a){d3.selectAll(".title .sort").style("display","block"),d3.select("#barChart_"+a+" .sort").style("display","none"),o=l[a],c()},k.dimension=function(a){return arguments.length?(g=a,k):g},k.filter=function(a){return a?(s.extent(a),g.filterRange(a)):(s.clear(),g.filterAll()),f=!0,k},k.group=function(a){return arguments.length?(h=a,k):h},k.round=function(a){return arguments.length?(i=a,k):i},k.title=function(a){return arguments.length?(j=a,k):j},k.x=function(a){return arguments.length?(e=a,p.scale(e),s.x(e),k):e},k.y=function(a){return arguments.length?(m=a,k):m},d3.rebind(k,s,"on")}function e(){e.id||(e.id=0);var a,d,f,g,h=[],i={},j=l.length;return i.apply=function(){try{d=arguments[0]}catch(a){return console.error("No DOM element specified"),!1}d=d.append("div").attr("id","wordCloud_"+j).attr("class","chart wordCloud"),i.drawChart()},i.drawChart=function(c){function e(){var a=d.append("div").attr("class","title").text(g);a.append("a").attr("class","reset").text("Reset").on("click",i.reset),a.append("a").attr("class","sort").text("Sort by").style("display",0===j?"none":"").on("click",function(){i.sortBy(j)}),m=d.append("div").attr("width",l).attr("class","wordcloud_container")}function k(a){return-1!==h.indexOf(a)}var l=q.view.width,m=d.select("div.wordcloud_container");(m.empty()||c)&&e();var n=m.selectAll("span").data(f.all().filter(function(a){return a.value>0?a:void 0}),function(a){return a.key}).sort(function(a,b){return b.key<a.key}),o=n.enter(),p=n.exit(),r=d3.scale.linear().domain([0,Math.min(d3.max(f.all(),function(a){return a.value}),10)]).range([0,1]);words_attributes={fontSize:function(a){return 9*Math.min(r(a.value),1)+8+"px"}},n.style("font-size",words_attributes.fontSize),o.append("span").text(function(a){return a.key}).style("font-size",words_attributes.fontSize).attr("class",function(a){return"term term_"+a.key+" "+(-1!==h.indexOf(a.key)?"selected":"")}).on("click",function(c){-1===h.indexOf(c.key)?(h.push(c.key),d3.select(this).classed("selected",1)):(h.splice(h.indexOf(c.key),1),d3.select(this).classed("selected",0)),h.length?(a.filterFunction(k),d3.select(this.parentNode).classed("filtered",1),d.select(".title a.reset").style("display","block")):i.reset(),b()}),p.remove()},i.redrawChart=function(){d.select("div.wordcloud_container").remove(),d.select(".title").remove(),i.drawChart(!0)},i.reset=function(){h=[],a.filterAll(),d.selectAll(".term").style("color",""),d.select(".filtered").classed("filtered",0),d.selectAll(".selected").classed("selected",0),d.select(".title a.reset").style("display",null),b()},i.sortBy=function(a){console.log("Hello"+a),d3.selectAll(".title .sort").style("display","block"),d3.select("#wordCloud_"+a+" .sort").style("display","none"),o=l[a],c()},i.dimension=function(b){return arguments.length?(a=b,i):a},i.group=function(a){return arguments.length?(f=a,i):f},i.title=function(a){return arguments.length?(g=a,i):g},i}var f="continuous",g="tags",h="unique";TT.crossfilter.id||(TT.crossfilter.id=0);var i,j,k,l=[],m=[],n=(TT.crossfilter.id++,!1),o=!1,p={},q={view:{width:400,height:30}};try{i=crossfilter(),test_cf=i}catch(r){return console.error("Crossfilter is not loaded. Get Crossfilter from http://square.github.io/crossfilter/"),!1}return p.apply=function(){k=arguments[0];for(var b=0;b<m.length;b++)a(m[b]);n=!0},p.addFilter=function(b){var c={};c.title=b.title||b.dimension.toString();var d;d="function"==typeof b.dimension?b.dimension:function(a){return a[b.dimension]},c.dimension=i.dimension(d),c.group=c.dimension.group(b.group?b.group:function(a){return a}),c.min=d3.min(j,d),c.max=d3.max(j,d),c.isDate=c.min instanceof Date;for(var e=!0,k=c.group.all(),l=0;l<k.length;l++)if(isNaN(+k[l].key.valueOf())){e=!1;break}return c.type=e?f:c.group.all().length==c.dimension.top(1/0).length?h:g,m.push(c),n&&a(c),p},p.forcePublish=function(){c()},p.charts=function(){return l},p.data=function(a){if(!arguments.length)return j;j=a,i.remove(),i.add(j);for(var b=0;b<l.length;b++)l[b].redrawChart();return c(),p},p.filters=function(){return m},p},String.prototype.ucfirst=function(){return this.charAt(0).toUpperCase()+this.slice(1)},TT.layout={},TT.layout.bars=function(){function a(){var a=(j.elements.events.selectAll("g.bars_event"),j.svg.select(".bars_axis"));j.scales.axis.domain([j.scales.pxToDate(l.domain()[0]),j.scales.pxToDate(l.domain()[1])]),b(),a.call(j.axis)}function b(){function a(a){a.append("rect").attr("class","eventRect").attr("x",0).attr("y",0).attr("height",k.event.rect.height).attr("width",k.event.rect.width).style("fill",k.event.rect.fill),a.append("text").attr("class","title").text(function(a){return a.title}).attr("x",k.event.text.x).attr("y",k.event.text.y).attr("text-anchor",k.event.text.anchor).attr("display",k.event.text.display)}function b(a){return a[h].renderLevel>=j.thresholds.display&&l(a[h].x)+a[h].width*e.scale()>=0&&l(a[h].x)<=j.view.width&&a[h].y+m(0)>-j.styles.events.height&&a[h].y+m(0)<j.view.height}function c(){function a(a){return a.weight?Math.pow(j.scales.minMax.weight(a.weight),.01/j.scales.minMax.zoom(e.scale()))+j.scales.minMax.zoom(e.scale()):0}j.data.forEach(function(b){b[h].renderLevel=a(b)}),(j.data.length<=j.thresholds.showAll||d3.min(j.data,function(a){return a[h].renderLevel})==d3.max(j.data,function(a){return a[h].renderLevel}))&&j.data.forEach(function(a){a[h].renderLevel=1});var b=0;j.data.forEach(function(a){a[h].renderLevel>=j.thresholds.display&&(a[h].x=j.scales.dateToPx(a.from.valueOf()),a[h].width=j.scales.dateToPx(a.to.valueOf())-j.scales.dateToPx(a.from.valueOf()),a[h].height=a[h].renderLevel<j.thresholds.collapse?j.styles.events.collapsedHeight:j.styles.events.height,a[h].margin=a[h].renderLevel<j.thresholds.collapse?j.styles.events.collapsedMargin:j.styles.events.margin,a[h].y=0===b?j.view.padding:j.view.ys[b-1]+a[h].margin,j.view.ys[b]=a[h].y+a[h].height,b++)})}function i(a){a.select("rect.eventRect").attr("width",k.event.rect.width).attr("height",k.event.rect.height).style("fill",k.event.rect.fill),a.select("text.title").attr("x",k.event.text.x).attr("y",k.event.text.y).attr("text-anchor",k.event.text.anchor).attr("display",k.event.text.display).style("font-size",k.event.text.fontSize)}if(!f)return!1;c(),j.displayData=j.data.filter(b);var n=j.elements.events.selectAll("g.bars_event").data(j.displayData,function(a){return a.id});n.attr("transform",k.event.transform),i(n);var o=n.enter().append("g").attr("id",function(a){return"tl"+g+"_event_"+a.id}).attr("class","bars_event").attr("transform",k.event.transform).on("click",function(a){console.log(a)}).on("dblclick",function(a){a.url&&window.open(a.url)});a(o),n.exit().remove(),d()}function c(){j.scales.minMax.weight.domain([d3.min(j.data,function(a){return a.weight?a.weight:0}),Math.min(300,d3.max(j.data,function(a){return a.weight?a.weight:0}))])}function d(){i.hasOwnProperty("publish")&&i.publish(j.displayData)}TT.layout.bars.id||(TT.layout.bars.id=0);var e,f=!1,g=TT.layout.bars.id++,h="tl_"+g,i={},j={axis:{},data:[],displayData:[],elements:{},format:{year:d3.time.format("%Y"),date:d3.time.format("%d %b %Y")},scales:{minMax:{weight:d3.scale.linear().domain([0,1]).range([0,1]),zoom:d3.scale.linear().domain([.01,120]).range([0,1])}},styles:{events:{height:12,collapsedHeight:2,fontSize:12,margin:1,collapsedMargin:1,padding:2}},thresholds:{collapse:.5,display:.1,showAll:10},view:{from:new Date(1900,0,1),to:new Date(2e3,0,1),width:800,height:600,padding:40,ys:[0]}};test_bars_p=j;var k={axis:{tickFormat:function(a){return Math.round((j.axis.scale().domain()[1].getFullYear()-j.axis.scale().domain()[0].getFullYear())/j.axis.ticks())>=1?j.format.year(a):j.format.date(a)}},event:{rect:{fill:function(a){return a.color||null},height:function(a){return Math.min(a[h].height*e.scale(),a[h].height)+"px"},width:function(a){return a[h].width*e.scale()+"px"}},text:{anchor:function(a){return e.scale()>=j.thresholds.collapse&&a[h].width*e.scale()>a.title.length*j.styles.events.fontSize?"start":"end"},display:function(a){return a[h].renderLevel>j.thresholds.collapse?"block":"none"},fontSize:j.styles.events.fontSize+"px",x:function(a){return a[h].width*e.scale()>a.title.length*j.styles.events.fontSize?l(a[h].x)<0&&l(a[h].x)+a[h].width*e.scale()>0?j.styles.events.padding+-1*l(a[h].x):j.styles.events.padding:-j.styles.events.padding},y:.75*j.styles.events.height},transform:function(a){return"translate("+l(a[h].x)+","+(a[h].y+m(0))+")"}}},l=d3.scale.linear().domain([0,j.view.width]).range([0,j.view.width]),m=d3.scale.linear().domain([0,j.view.height]).range([0,j.view.height]);return i.apply=function(){function c(){function b(){j.scales.axis=d3.time.scale().domain([j.scales.pxToDate(l.domain()[0]),j.scales.pxToDate(l.domain()[1])]).range([0,j.view.width]),j.axis=d3.svg.axis().scale(j.scales.axis).tickSize(j.view.height-j.view.padding).tickFormat(k.axis.tickFormat).orient("top"),j.elements.axis=j.svg.append("g").attr("class","bars_axis").attr("id","tl"+g+"_axis").call(j.axis).attr("transform","translate(0,"+(j.view.height-j.view.padding/2)+")")}function c(){j.elements.events=j.svg.insert("g").attr("class","bars_events").attr("id","tl"+g+"_events")}function d(){j.scales.dateToPx=d3.scale.linear().domain([j.view.from.valueOf(),j.view.to.valueOf()]).range([j.view.padding,j.view.width-j.view.padding]),j.scales.pxToDate=d3.scale.linear().domain([j.view.padding,j.view.width-j.view.padding]).range([j.view.from.valueOf(),j.view.to.valueOf()])}function f(){e=d3.behavior.zoom().x(l).y(m).scaleExtent(j.scales.minMax.zoom.domain()),j.svg.select(".bars_events").insert("rect",":first-child").attr("width",j.view.width).attr("height",j.view.height).attr("class","overlay"),j.svg.select(".bars_events").call(e.on("zoom",a)).on("dblclick.zoom",null)}d(),c(),b(),f()}if(j.svg=arguments[0],j.view.width=j.svg.attr("width"),j.view.height=j.svg.attr("height"),j.data){var d=d3.min(j.data,function(a){return a.from}),h=d3.max(j.data,function(a){return a.to});j.view.from=new Date(d.valueOf()-.2*(h.valueOf()-d.valueOf())),j.view.to=new Date(h.valueOf()+.2*(h.valueOf()-d.valueOf()))}c(),f=!0,b()},i.data=function(a){return arguments.length?(j.data=a,j.data.forEach(function(a){a.hasOwnProperty(h)||(a[h]={})}),c(),b(),i):j.data},i.displayData=function(){return j.displayData},i.update=function(){b()},i.x=function(a){return arguments.length?(l=a,i):l},i.y=function(a){return arguments.length?(m=a,i):m},i.zoom=function(a){return arguments.length?(e=a,i):e},i.styles={},i.styles.events=function(a,c){if(arguments.length<2){if("string"==typeof a)return j.styles.events[a];if("object"==typeof a)for(var d in a)j.styles.events[d]=a[d]}else j.styles.events[a]=c;return b(),i},i.threshold=function(a,c){if(arguments.length<2){if("string"==typeof a)return j.thresholds[a];if("object"==typeof a)for(var d in a)j.thresholds[d]=a[d]}else j.thresholds[a]=c;return b(),i},i},TT.layout.heap=function(){function a(){function a(a){a.append("circle").attr("class","event_circle").attr("cx",l.event.circle.cx).attr("cy",l.event.circle.cy).attr("r",l.event.circle.r).style("fill",l.event.circle.fill)}function d(a){return b(a[j].x)>=0&&b(a[j].x)<=k.view.width&&c(a[j].y)>-k.styles.events.diameter&&c(a[j].y)<k.view.height}function e(){function a(){k.grid.availableWidth=k.scales.dateToPx(k.view.to)-k.scales.dateToPx(k.view.from),k.grid.numCols=Math.floor(k.grid.availableWidth/k.styles.events.diameter),k.grid.range=k.view.to-k.view.from,k.grid.resolution=k.grid.range/k.grid.numCols,k.grid.table=[];for(var a=0;a<k.grid.numCols;a++)k.grid.table[a]=Array();k.grid.maxRow=0,k.data.forEach(function(a){a[j].col=a[j].initCol=Math.min(Math.floor((a.from.valueOf()+(a.to.valueOf()-a.from.valueOf())/2-k.view.from.valueOf())/k.grid.resolution),k.grid.numCols-1),a[j].minCol=Math.max(Math.floor((a.from.valueOf()-k.view.from.valueOf())/k.grid.resolution),0),a[j].maxCol=Math.min(Math.ceil((a.to.valueOf()-k.view.from.valueOf())/k.grid.resolution),k.grid.numCols-1),a[j].candidateCols=d3.range(a[j].initCol,a[j].minCol-1,-1).concat(d3.range(a[j].initCol+1,a[j].maxCol+1));for(var b=k.grid.maxRow,c=0;c<a[j].candidateCols.length;c++)k.grid.table[a[j].candidateCols[c]].length<b&&(a[j].col=a[j].candidateCols[c],b=k.grid.table[a[j].candidateCols[c]].length);a[j].row=b,k.grid.table[a[j].col][a[j].row]=a,b==k.grid.maxRow&&k.grid.maxRow++})}return k.grid.initialised?!1:(a(),k.data.forEach(function(a){a[j].x=k.scales.dateToPx(a[j].col*k.grid.resolution+k.view.from.valueOf());var b=k.grid.table[a[j].col].length*k.styles.events.diameter/2+k.view.height/2;a[j].y=-a[j].row*k.styles.events.diameter+b-b%k.styles.events.diameter}),void(k.grid.initialised=!0))}function m(a){a.select("circle.eventCircle").attr("r",l.event.circle.r).style("fill",l.event.circle.fill)}function n(a){f.scale()>k.thresholds.images?(a.filter(function(a){return!a.hasImage&&a.thumbnailUrl}).append("image").attr("xlink:href",function(a){return a.hasImage=!0,a.thumbnailUrl}),a.selectAll("image").attr("x",-f.scale()/2*k.styles.images.factor).attr("y",-f.scale()/2*k.styles.images.factor).attr("width",f.scale()*k.styles.images.factor+"px").attr("height",f.scale()*k.styles.images.factor+"px")):(a.selectAll("image").remove(),a.each(function(a){a.hasImage=!1}))}if(!g)return!1;e();var o=k.data.filter(d);o.length>k.thresholds.display&&(o=[]);var p=k.elements.events.selectAll("g.heap_event").data(o,function(a){return a.id}),q=p.enter().append("g").attr("id",function(a){return"hs"+h+"_event_"+a.id}).attr("class","heap_event").attr("transform",l.event.transform).on("click",function(a){i.hasOwnProperty("publish")&&i.publish({data:a,event:d3.event})}).on("dblclick",function(a){i.hasOwnProperty("publish")&&i.publish({data:a,event:d3.event})}).each(function(a){a.hasImage=!1});a(q),p.attr("transform",l.event.transform),m(p),p.exit().remove(),n(p),k.elements.outline.attr("d",function(){for(var a,d=[],e=-1,f=k.grid.table.length;++e<f;)a=k.grid.table[e],a.length>0&&(d.push("S",b(a[a.length-1][j].x-k.styles.events.diameter/2),",",c(a[a.length-1][j].y)," ",b(a[a.length-1][j].x),",",c(a[a.length-1][j].y)),d.unshift("S",b(a[0][j].x+k.styles.events.diameter/2),",",c(a[0][j].y)," ",b(a[0][j].x),",",c(a[0][j].y)));return d.unshift("M",d[1],",",d[3]),d.push("Z"),d.join("")}).attr("display",function(){return o.length>0?"none":""})}function b(a){return d(a)+f.scale()*k.translate[0]}function c(a){return e(a)+f.scale()*k.translate[1]}TT.layout.heap.id||(TT.layout.heap.id=0);var d,e,f,g=!1,h=TT.layout.heap.id++,i={},j="hp_"+h,k={data:[],elements:{},grid:{availableWidth:null,maxRow:0,numCols:null,initialised:!1,range:null,resolution:null,table:[]},parent:!1,styles:{events:{diameter:1},images:{factor:1}},thresholds:{display:2e3,images:30},translate:[0,0],view:{}};test_heap_p=k;var l={event:{circle:{cx:-k.styles.events.diameter/2,cy:-k.styles.events.diameter/2,fill:function(a){return a.color||null},r:function(){return Math.min(10,f.scale())*k.styles.events.diameter/2}},transform:function(a){return"translate("+b(a[j].x)+","+c(a[j].y)+")"}}};return i.apply=function(){function b(){function a(){k.elements.outline=k.svg.insert("g").attr("class","heap_outline").attr("id","hs"+h+"_outline").append("path"),k.elements.events=k.svg.insert("g").attr("class","heap_events").attr("id","hs"+h+"_events")}a()}b(),g=!0,a()},i.data=function(b){if(!arguments.length)return k.data;if(k.data=b,k.data.forEach(function(a){a.hasOwnProperty(j)||(a[j]={})}),k.grid.initialised=!1,g){var c=d3.min(k.data,function(a){return a.from}),d=d3.max(k.data,function(a){return a.to});c<k.view.from&&parent.from(c),d>k.view.to&&parent.to(d),a()}return i},i.identifier=function(){return j},i.initialise=function(){return k.svg.call(i),i},i.scales=function(a){return arguments.length?(k.scales=a,i):k.scales},i.styles={},i.styles.events=function(b,c){if(arguments.length<2){if("string"==typeof b)return k.styles.events[b];if("object"==typeof b)for(var d in b)k.styles.events[d]=b[d]}else k.styles.events[b]=c;return k.grid.initialised=!1,a(),i},i.svg=function(a){return arguments.length?(k.svg=a,i):k.svg},i.parent=function(a){return arguments.length?(k.parent=a,i):k.parent},i.threshold=function(b,c){if(arguments.length<2){if("string"==typeof b)return k.thresholds[b];if("object"==typeof b)for(var d in b)k.thresholds[d]=b[d]}else k.thresholds[b]=c;return a(),i},i.update=function(){return a(),i},i.refresh=function(){return k.grid.initialised=!1,a(),i},i.view=function(a){return arguments.length?(k.view=a,i):k.view},i.x=function(a){return arguments.length?(d=a,i):d},i.y=function(a){return arguments.length?(e=a,i):e},i.zoom=function(a){return arguments.length?(f=a,heap_zoom=f,i):f},i},TT.observer={addSubscriber:function(a){this.subscribers[this.subscribers.length]=a},removeSubscriber:function(a){for(var b=0;b<this.subscribers.length;b++)this.subscribers[b]===a&&delete this.subscribers[b]},publish:function(a){for(var b=0;b<this.subscribers.length;b++)"function"==typeof this.subscribers[b]&&this.subscribers[b](a)},make:function(a){for(var b in this)a[b]=this[b],a.subscribers=[]}},TT.timeline=function(){function a(){j.scales.axis.domain([j.scales.pxToDate(c.domain()[0]),j.scales.pxToDate(c.domain()[1])]),j.elements.axis.call(j.axis),b()}function b(){j.children.forEach(function(a){a.update()})}TT.timeline.id||(TT.timeline.id=0);var c,d,e,f=!1,g=TT.timeline.id++,h={},i="tl_"+g,j={axis:{},children:[],elements:{},format:{year:d3.time.format("%Y"),date:d3.time.format("%d %b %Y")},scales:{minMax:{zoom:d3.scale.linear().domain([.5,240]).range([0,1])}},svg:!1,view:{from:new Date(1900,0,1),to:new Date(2e3,0,1),width:800,height:600,padding:40}};test_timeline_p=j;var k={axis:{tickFormat:function(a){return Math.round((j.axis.scale().domain()[1].getFullYear()-j.axis.scale().domain()[0].getFullYear())/j.axis.ticks())>=1?j.format.year(a):j.format.date(a)}}};return h.apply=function(){function b(){function b(){j.scales.axis=d3.time.scale().domain([j.scales.pxToDate(c.domain()[0]),j.scales.pxToDate(c.domain()[1])]).range([0,j.view.width]),j.axis=d3.svg.axis().scale(j.scales.axis).tickSize(j.view.height-j.view.padding).tickFormat(k.axis.tickFormat).orient("top"),j.elements.axis=j.svg.insert("g",":first-child").attr("class","timeline_axis axis").attr("id",i+"_axis").call(j.axis).attr("transform","translate(0,"+(j.view.height-j.view.padding/2)+")")}function f(){c=d3.scale.linear().domain([0,j.view.width]).range([0,j.view.width]),d=d3.scale.linear().domain([0,1]).range([0,1]),test_timeline_x=c,test_timeline_y=d,j.scales.dateToPx=d3.scale.linear().domain([j.view.from.valueOf(),j.view.to.valueOf()]).range([j.view.padding,j.view.width-j.view.padding]),j.scales.pxToDate=d3.scale.linear().domain(j.scales.dateToPx.range()).range(j.scales.dateToPx.domain())}function g(){e=d3.behavior.zoom().x(c).y(d).scaleExtent(j.scales.minMax.zoom.domain()),test_timeline_zoom=e,j.elements.children=j.svg.insert("g").attr("class","timeline_children").attr("id",i+"_children").call(e.on("zoom",a)).on("dblclick.zoom",null),j.elements.children.insert("rect",":first-child").attr("width",j.view.width).attr("height",j.view.height).attr("class","overlay")}f(),b(),g()}j.svg=arguments[0],j.view.width=+j.svg.attr("width")||j.view.width,j.view.height=+j.svg.attr("height")||j.view.width,b(),f=!0},h.refresh=function(){function a(){j.scales.axis.domain([j.scales.pxToDate(c.domain()[0]),j.scales.pxToDate(c.domain()[1])]).range([0,j.view.width]),j.axis.tickSize(j.view.height-j.view.padding),j.elements.axis.call(j.axis).attr("transform","translate(0,"+(j.view.height-j.view.padding/2)+")")}function b(){var a=j.view.width-c.range()[1];c.range([0,j.view.width]).domain([c.domain()[0],c.domain()[1]+a]),j.scales.dateToPx.domain([j.view.from.valueOf(),j.view.to.valueOf()]).range([j.view.padding,j.view.width-j.view.padding]),j.scales.pxToDate.domain(j.scales.dateToPx.range()).range(j.scales.dateToPx.domain())}function d(){j.svg.attr("width",j.view.width),j.svg.attr("height",j.view.height)}function e(){j.svg.select(".overlay").attr("width",j.view.width).attr("height",j.view.height)}d(),b(),a(),e(),j.children.forEach(function(a){a.refresh()})},h.add=function(a){var f=j.elements.children.append("g").attr("id",a.identifier());if(a.svg(f).view(j.view).scales(j.scales).x(c).y(d).zoom(e).parent(h),a.data().length){var g=d3.min(a.data(),function(a){return a.from}),i=d3.max(a.data(),function(a){return a.to});g<j.view.from&&h.from(g),i>j.view.to&&h.to(i)}a.initialise(),j.children.push(a),b()},h.domain=function(a){return arguments.length?(2===a.length&&a[0]instanceof Date&&a[1]instanceof Date&&a[1]>a[0]&&(j.view.from=a[0],j.view.to=a[1]),h):Array(j.view.from,j.view.to)},h.from=function(a){return arguments.length?(j.view.from=a,h.refresh(),h):j.view.from},h.height=function(a){return arguments.length?(j.view.height=a,h.refresh(),h):j.view.height},h.view=function(){return j.view},h.width=function(a){return arguments.length?(j.view.width=a,h.refresh(),h):j.view.width},h.to=function(a){return arguments.length?(j.view.to=a,h.refresh(),h):j.view.to},h.x=function(a){return arguments.length?(c=a,h):c},h.y=function(a){return arguments.length?(d=a,h):d},h},TT.ui={},TT.ui.panel=function(){function a(a){function b(a){f.elements.panel.header.select("h2").html(f.record.title.call(f.record.title,a)),f.elements.panel.header.select("h3").html(f.record.subtitle.call(f.record.subtitle,a)),f.elements.panel.header.style("background-image","url("+f.record.image.call(f.record.image,a)+")")}console.log(a.event),f.elements.panel.style("display","block"),a.event.pageY>f.elements.panel.height/2?f.elements.panel.style("top",a.event.pageY-f.elements.panel.height/2-f.styles.panel.pointer.height/2+"px"):f.elements.panel.style("top",f.styles.panel.pointer.height/2+"px"),a.event.pageX>f.elements.panel.width+f.styles.panel.pointer.width?f.elements.panel.style("left",a.event.pageX-f.elements.panel.width-f.styles.panel.pointer.width+"px").classed("pointerLeft",!0).classed("pointerRight",!1):f.elements.panel.style("left",a.event.pageX+f.styles.panel.pointer.width+"px").classed("pointerLeft",!1).classed("pointerRight",!0),b(a.data)}function b(b){switch(b.event.type){case"click":console.log(b.data),a(b);break;case"dblclick":b.data.url&&window.open(b.data.url)}}TT.ui.panel.id||(TT.ui.panel.id=0);var c=!1,d=TT.ui.panel.id++,e={},f={elements:{},data:[],heap:!1,fields:[],parent:!1,record:{title:function(a){return a.title},subtitle:function(a){return a.subtitle},image:function(a){return a.image}},styles:{panel:{height:.6,width:.25,pointer:{width:10,height:20}}},view:{}};return test_ui_p=f,e.initialise=function(){function a(){fields.forEach(function(a){a.values=[],f.data.forEach(function(b){value=a.accessor.call(a.accessor,b),"[object Array]"!==toString.call(value)&&(value=[value]),value.forEach(function(b){if(b instanceof Object){for(var c=!1,d=0;d<a.values.length;d++)if(a.values[d]instanceof Object&&a.values[d].id===b.id){c=!0;break}c||a.values.push(b)}else-1===a.values.indexOf(b)&&a.values.push(b)})})})}function b(){f.elements.panel=d3.select("body").append("div").attr("class","ui_panel").attr("id","ui_panel_"+d),f.elements.panel.style("display","block"),f.elements.panel.width=parseInt(f.elements.panel.style("width")),f.elements.panel.height=parseInt(f.elements.panel.style("height")),f.elements.panel.style("display","none"),f.elements.panel.append("div").attr("class","pointer pointerLeft"),f.elements.panel.append("div").attr("class","pointer pointerRight"),f.elements.panel.header=f.elements.panel.append("div").attr("class","header"),f.elements.panel.header.append("h2"),f.elements.panel.header.append("h3"),f.elements.panel.header.list=f.elements.panel.append("ul")}return a(),b(),c=!0,e},e.heap=function(){return arguments.length?(TT.observer.make(heap),heap.addSubscriber(b),f.data=heap.data(),e):f.heap},e.fields=function(a){return arguments.length?(f.fields=a,e):f.fields},e.record=function(a){return arguments.length?(f.record=a,e):f.record},e};